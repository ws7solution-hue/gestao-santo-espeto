<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santo Espeto - Gest√£o v17.7 (Comparador de Pre√ßos)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary-color: #5C3A21; --secondary-color: #FFC107; --bg-light: #f8f9fa; }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', sans-serif; }
        
        .sidebar { height: 100vh; background-color: var(--primary-color); color: white; position: fixed; width: 250px; padding-top: 20px; overflow-y: auto; z-index: 1000; }
        .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 16px; color: white; display: block; transition: 0.3s; border-left: 5px solid transparent; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(255, 193, 7, 0.1); color: var(--secondary-color); border-left: 5px solid var(--secondary-color); font-weight: bold; }
        .content { margin-left: 250px; padding: 20px; }
        .card-custom { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
        
        .bg-gradient-brown { background: linear-gradient(45deg, #5C3A21, #8B5A2B); color: white; }
        .bg-gradient-red { background: linear-gradient(45deg, #d32f2f, #ef5350); color: white; }
        .bg-gradient-green { background: linear-gradient(45deg, #2e7d32, #4caf50); color: white; }
        
        .text-venda { color: #2e7d32; font-weight: bold; } 
        .text-compra { color: #c62828; font-weight: bold; } 
        .text-saque { color: #d32f2f; } 
        .text-aporte { color: #0277bd; font-weight: bold; }

        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column; }
        
        @media (max-width: 768px) { .sidebar { width: 100%; height: auto; position: relative; } .content { margin-left: 0; } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3 text-dark">Carregando Sistema...</h5>
        <small class="text-muted" id="loading-msg">Conectando ao banco de dados...</small>
    </div>

    <div class="sidebar">
        <div class="text-center mb-4">
            <h3 class="mt-2"><i class="fas fa-fire"></i> Santo Espeto</h3>
            <small>Gest√£o Cloud v17.7</small>
        </div>
        <a href="#" onclick="showSection('dashboard')" class="nav-link active"><i class="fas fa-chart-line"></i> Dashboard</a>
        <a href="#" onclick="showSection('extrato')" class="nav-link"><i class="fas fa-university"></i> Extrato Detalhado</a>
        <a href="#" onclick="showSection('insumos')" class="nav-link"><i class="fas fa-box-open"></i> 1. Compras (Insumos)</a>
        <a href="#" onclick="showSection('produtos')" class="nav-link"><i class="fas fa-utensils"></i> 2. Card√°pio / Combos</a>
        <a href="#" onclick="showSection('pdv')" class="nav-link"><i class="fas fa-cash-register"></i> Frente de Caixa</a>
        <a href="#" onclick="showSection('anotacoes')" class="nav-link"><i class="fas fa-clipboard-list"></i> Anota√ß√µes & Pre√ßos</a>
    </div>

    <div class="content">
        <div id="dashboard" class="section">
            <h2>üìä Vis√£o Geral</h2>
            <hr>
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card card-custom p-3 bg-white">
                        <h5 class="mb-3">Caixa R√°pido</h5>
                        <div class="d-flex gap-3">
                            <button class="btn btn-outline-danger flex-grow-1" data-bs-toggle="modal" data-bs-target="#modalSaque"><i class="fas fa-hand-holding-usd"></i> Saque</button>
                            <button class="btn btn-outline-primary flex-grow-1" data-bs-toggle="modal" data-bs-target="#modalAporte"><i class="fas fa-piggy-bank"></i> Aporte</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-4 g-3">
                <div class="col-md-3"><div class="card card-custom bg-gradient-red p-3"><small>Total Comprado</small><h2 id="dash-gastos">R$ 0,00</h2></div></div>
                <div class="col-md-3"><div class="card card-custom bg-gradient-green p-3"><small>Total Vendido</small><h2 id="dash-faturamento">R$ 0,00</h2></div></div>
                <div class="col-md-3"><div class="card card-custom bg-gradient-brown p-3"><small>Lucro Operacional</small><h2 id="dash-lucro">R$ 0,00</h2></div></div>
                <div class="col-md-3"><div class="card card-custom bg-secondary text-white p-3"><small>Saldo em Caixa</small><h2 id="dash-caixa">R$ 0,00</h2></div></div>
            </div>
        </div>

        <div id="extrato" class="section d-none">
            <h2>üìë Extrato Financeiro</h2>
            <hr>
            <div class="card card-custom p-3 mb-4">
                <div class="row g-2 align-items-end">
                    <div class="col-md-2">
                        <label>Filtrar por:</label>
                        <select id="ext-filtro-tipo" class="form-select">
                            <option value="TODOS">Todos</option>
                            <option value="VENDA">Vendas</option>
                            <option value="COMPRA">Compras</option>
                            <option value="MOV">Caixa (Saque/Aporte)</option>
                        </select>
                    </div>
                    <div class="col-md-3"><label>In√≠cio</label><input type="date" id="ext-data-ini" class="form-control"></div>
                    <div class="col-md-3"><label>Fim</label><input type="date" id="ext-data-fim" class="form-control"></div>
                    <div class="col-md-2"><button onclick="filtrarExtrato()" class="btn btn-primary w-100">Filtrar</button></div>
                    <div class="col-md-2"><button onclick="limparFiltrosExtrato()" class="btn btn-outline-secondary w-100">Resetar</button></div>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-md-8"><div class="card card-custom p-3 h-100"><canvas id="chartExtrato" style="max-height: 250px;"></canvas></div></div>
                <div class="col-md-4">
                    <div class="card card-custom p-3 bg-light h-100">
                        <h5>Resumo</h5>
                        <ul class="list-group list-group-flush small">
                            <li class="list-group-item d-flex justify-content-between"><span class="text-success">Entradas</span><span id="res-entradas">R$ 0,00</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span class="text-danger">Sa√≠das</span><span id="res-saidas">R$ 0,00</span></li>
                            <li class="list-group-item d-flex justify-content-between"><strong>Saldo</strong><strong id="res-saldo">R$ 0,00</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card card-custom p-3"><div class="table-responsive"><table class="table table-striped table-sm"><thead class="table-dark"><tr><th>Data</th><th>C√≥d/Tipo</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody id="tabela-extrato"></tbody></table></div></div>
        </div>

        <div id="insumos" class="section d-none">
            <h2>üì¶ Insumos & Custos</h2>
            <hr>
            <div class="card card-custom p-4 mb-4 border-start border-5 border-primary">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 id="titulo-form-insumo" class="m-0">Nova Compra</h4>
                    <button id="btn-cancelar-edicao" class="btn btn-sm btn-secondary d-none" onclick="cancelarEdicaoInsumo()">Cancelar</button>
                </div>
                <input type="hidden" id="ins-id-edicao">
                <div class="row g-2 align-items-end">
                    <div class="col-md-3"><label>Item</label><input type="text" id="ins-nome" class="form-control" placeholder="Ex: Pct Embalagem"></div>
                    <div class="col-md-2"><label>Qtd Pacote</label><input type="number" id="ins-qtd-pacote" class="form-control" placeholder="Ex: 100"></div>
                    
                    <div class="col-md-2 d-none" id="div-estoque-atual">
                        <label class="text-danger fw-bold">Estoque Atual</label>
                        <input type="number" id="ins-estoque-atual" class="form-control border-danger fw-bold">
                    </div>

                    <div class="col-md-2"><label>Unidade</label><select id="ins-unidade" class="form-select"><option value="un">Un</option><option value="kg">kg</option><option value="g">g</option><option value="lt">lt</option></select></div>
                    <div class="col-md-2"><label>Valor Pago</label><input type="text" id="ins-valor-pago" class="form-control" placeholder="Ex: 25,90"></div>
                    <div class="col-md-1"><button onclick="salvarInsumo()" id="btn-salvar-insumo" class="btn btn-primary w-100 fw-bold"><i class="fas fa-check"></i></button></div>
                </div>
                <div class="mt-2 text-primary fw-bold" id="preview-custo"><i class="fas fa-calculator"></i> Custo Unit√°rio: R$ 0,000</div>
            </div>
            <div class="card card-custom p-3"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Item</th><th>Valor Total</th><th>Custo Unit.</th><th>Estoque</th><th class="text-end">A√ß√µes</th></tr></thead><tbody id="tabela-insumos"></tbody></table></div>
        </div>

        <div id="produtos" class="section d-none">
            <h2>üç¢ Card√°pio & Combos</h2>
            <hr>
            <div class="row">
                <div class="col-md-5">
                    <div class="card card-custom p-4 border-start border-5 border-warning">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 id="titulo-form-prod" class="m-0">Novo Produto/Combo</h4>
                            <button id="btn-cancelar-prod" class="btn btn-sm btn-secondary d-none" onclick="cancelarEdicaoProduto()">Cancelar</button>
                        </div>
                        
                        <input type="hidden" id="prod-id-edicao">

                        <div class="mb-2"><input type="text" id="prod-nome" class="form-control" placeholder="Nome (Ex: Combo Casal)"></div>
                        <div class="mb-2"><input type="text" id="prod-preco" class="form-control" placeholder="Pre√ßo de Venda (Ex: 45,90)"></div>
                        
                        <hr>
                        <div class="mb-2">
                            <label class="form-label small">O que adicionar na receita?</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="tipoItemAdd" id="radioInsumo" value="insumo" checked onchange="toggleTipoAdd()">
                                <label class="btn btn-outline-secondary" for="radioInsumo">Mat√©ria Prima</label>

                                <input type="radio" class="btn-check" name="tipoItemAdd" id="radioProduto" value="produto" onchange="toggleTipoAdd()">
                                <label class="btn btn-outline-warning" for="radioProduto">Produto Pronto</label>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-2">
                            <select id="select-insumo-add" class="form-select"></select>
                            <select id="select-produto-add" class="form-select d-none"></select>
                            
                            <input type="number" id="qtd-insumo-add" class="form-control" placeholder="Qtd" style="width: 80px;" value="1">
                            <button type="button" id="btn-add-ingrediente" class="btn btn-secondary"><i class="fas fa-plus"></i></button>
                        </div>
                        
                        <ul id="lista-ingredientes-temp" class="list-group mb-3 small"></ul>
                        
                        <div class="alert alert-secondary p-1 text-center">
                            Custo: <strong id="prod-custo-total">R$ 0,00</strong> | Lucro: <strong id="prod-lucro-previsto" class="text-success">R$ 0,00</strong>
                        </div>
                        
                        <button type="button" id="btn-salvar-prod" class="btn btn-success w-100">Salvar Produto/Combo</button>
                    </div>
                </div>
                <div class="col-md-7"><div class="card card-custom p-3"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Produto</th><th>Venda</th><th>Lucro</th><th class="text-end">A√ß√µes</th></tr></thead><tbody id="tabela-produtos"></tbody></table></div></div>
            </div>
        </div>

        <div id="pdv" class="section d-none">
            <h2>üõí Frente de Caixa</h2>
            <hr>
            <div class="row">
                <div class="col-md-5">
                    <div class="card card-custom p-4">
                        <h4>Lan√ßar Pedido</h4>
                        <div class="mb-3">
                            <label>Produto / Combo</label>
                            <select id="pdv-produto" class="form-select form-select-lg"></select>
                        </div>
                        <div class="mb-3">
                            <label>Quantidade</label>
                            <input type="number" id="pdv-qtd" class="form-control form-control-lg" value="1">
                        </div>
                        <button onclick="addCarrinho()" class="btn btn-warning w-100 btn-lg">Adicionar ao Carrinho</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card card-custom p-4 bg-white">
                        <h4>Carrinho de Compras</h4>
                        <div class="table-responsive">
                            <table class="table table-striped align-middle">
                                <thead class="table-light"><tr><th>Item</th><th>Venda</th><th>Lucro Liq.</th><th></th></tr></thead>
                                <tbody id="pdv-carrinho"></tbody>
                            </table>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="text-muted">Total:</h4>
                            <h2 id="pdv-total">R$ 0,00</h2>
                        </div>
                        <button onclick="finalizarVenda()" class="btn btn-success w-100 btn-lg mt-3">Receber Pedido (Gerar C√≥digo)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="anotacoes" class="section d-none">
            <h2>üìù Anota√ß√µes & Fornecedores</h2>
            <hr>
            
            <div class="card card-custom p-3 mb-4 bg-white border-start border-5 border-secondary">
                <h5>üîç Comparador de Pre√ßos</h5>
                <div class="input-group">
                    <input type="text" id="comp-busca" class="form-control" placeholder="Digite o produto (Ex: Maionese)">
                    <button class="btn btn-secondary" onclick="compararPrecos()"><i class="fas fa-search"></i> Buscar Hist√≥rico</button>
                </div>
                <div id="resultado-comparacao" class="mt-3"></div>
            </div>
            <div class="card card-custom p-3 mb-4 bg-light">
                <div class="row align-items-center">
                    <div class="col-md-2"><strong>Filtrar M√™s:</strong></div>
                    <div class="col-md-4"><input type="month" id="filtro-mes-anotacao" class="form-control"></div>
                    <div class="col-md-2"><button onclick="renderAnotacoes()" class="btn btn-primary w-100">Buscar</button></div>
                    <div class="col-md-2"><button onclick="limparFiltroAnotacoes()" class="btn btn-outline-secondary w-100">Ver Tudo</button></div>
                </div>
            </div>
            <div class="card card-custom p-4 mb-4 border-start border-5 border-info">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 id="titulo-form-anot" class="m-0">Nova Anota√ß√£o</h4>
                    <button id="btn-cancelar-anot" class="btn btn-sm btn-secondary d-none" onclick="cancelarEdicaoAnotacao()">Cancelar</button>
                </div>
                <input type="hidden" id="anot-id-edicao">
                <div class="row g-2">
                    <div class="col-md-3"><input type="text" id="anot-item" class="form-control" placeholder="Item (Ex: Alcatra)"></div>
                    <div class="col-md-3"><input type="text" id="anot-fornecedor" class="form-control" placeholder="Fornecedor"></div>
                    <div class="col-md-2"><input type="text" id="anot-contato" class="form-control" placeholder="Contato"></div>
                    <div class="col-md-2"><input type="text" id="anot-preco" class="form-control" placeholder="Pre√ßo (R$)"></div>
                    <div class="col-md-2"><input type="date" id="anot-data" class="form-control"></div>
                </div>
                <button onclick="salvarAnotacao()" id="btn-salvar-anot" class="btn btn-info text-white w-100 mt-3 fw-bold">Salvar Anota√ß√£o</button>
            </div>
            <div class="card card-custom p-3">
                <div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-dark"><tr><th>Data</th><th>Item</th><th>Fornecedor</th><th>Contato</th><th>Pre√ßo</th><th class="text-end">A√ß√µes</th></tr></thead><tbody id="tabela-anotacoes"></tbody></table></div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modalSaque" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">Saque</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="saque-valor" class="form-control mb-2" placeholder="Valor (R$)"><input type="text" id="saque-desc" class="form-control" placeholder="Motivo"></div><div class="modal-footer"><button class="btn btn-danger" onclick="registrarMovimentacao('SAQUE')">Confirmar</button></div></div></div></div>
    <div class="modal fade" id="modalAporte" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Aporte</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="aporte-valor" class="form-control mb-2" placeholder="Valor (R$)"><input type="text" id="aporte-desc" class="form-control" placeholder="Origem"></div><div class="modal-footer"><button class="btn btn-primary" onclick="registrarMovimentacao('APORTE')">Confirmar</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CREDENCIAIS
        const firebaseConfig = {
            apiKey: "AIzaSyDSSMRu3204Qx6D_HePLXOvWqZGYEuex3E",
            authDomain: "gestao-santo-espeto.firebaseapp.com",
            projectId: "gestao-santo-espeto",
            storageBucket: "gestao-santo-espeto.firebasestorage.app",
            messagingSenderId: "196041456523",
            appId: "1:196041456523:web:655bd6ac06ea34b06e4d8e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // VARI√ÅVEIS
        let insumos = [], produtos = [], vendas = [], movCaixa = [], listaAnotacoes = [];
        let ingredientesTemp = [], carrinho = [];

        // HELPER
        function parseMoney(val) {
            if(!val) return 0;
            if(typeof val === 'number') return val;
            let str = val.toString().replace('.', '').replace(',', '.'); 
            if (val.toString().indexOf(',') > -1 && val.toString().indexOf('.') === -1) {
                return parseFloat(val.toString().replace(',', '.'));
            }
            return parseFloat(str) || 0;
        }

        // --- INIT ---
        async function init() {
            try {
                setTimeout(() => { document.getElementById('loading-overlay').style.display = 'none'; }, 8000);

                await carregarDados();
                atualizarTabelas();
                atualizarDashboard();
                limparFiltrosExtrato();
                renderAnotacoes();
                
                // EVENTOS CORRIGIDOS (EVITA DUPLICA√á√ÉO)
                const btnAdd = document.getElementById('btn-add-ingrediente');
                if(btnAdd) {
                    btnAdd.replaceWith(btnAdd.cloneNode(true)); 
                    document.getElementById('btn-add-ingrediente').addEventListener('click', addItemAoProduto);
                }

                const btnSalvar = document.getElementById('btn-salvar-prod');
                if(btnSalvar) {
                     btnSalvar.replaceWith(btnSalvar.cloneNode(true));
                     document.getElementById('btn-salvar-prod').addEventListener('click', salvarProdutoFinal);
                }

                const inputPreco = document.getElementById('prod-preco');
                if(inputPreco) inputPreco.addEventListener('input', renderIngredientesTemp);

                document.getElementById('anot-data').value = new Date().toISOString().split('T')[0];
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (error) {
                console.error("ERRO:", error);
                alert("Erro ao conectar: " + error.message);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        async function carregarDados() {
            const [sIns, sProd, sVen, sMov, sAnot] = await Promise.all([
                getDocs(collection(db, "insumos")),
                getDocs(collection(db, "produtos")),
                getDocs(collection(db, "vendas")),
                getDocs(collection(db, "mov_caixa")),
                getDocs(collection(db, "anotacoes_precos"))
            ]);
            insumos = sIns.docs.map(d => ({ id: d.id, ...d.data() }));
            produtos = sProd.docs.map(d => ({ id: d.id, ...d.data() }));
            vendas = sVen.docs.map(d => ({ id: d.id, ...d.data() }));
            movCaixa = sMov.docs.map(d => ({ id: d.id, ...d.data() }));
            listaAnotacoes = sAnot.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        // --- L√ìGICA DE PRODUTOS/COMBOS ---
        window.toggleTipoAdd = function() {
            let tipo = document.querySelector('input[name="tipoItemAdd"]:checked').value;
            let selInsumo = document.getElementById('select-insumo-add');
            let selProd = document.getElementById('select-produto-add');
            
            if(tipo === 'insumo') {
                selInsumo.classList.remove('d-none');
                selProd.classList.add('d-none');
            } else {
                selInsumo.classList.add('d-none');
                selProd.classList.remove('d-none');
            }
        }

        function addItemAoProduto() {
            let tipo = document.querySelector('input[name="tipoItemAdd"]:checked').value;
            let qtdInput = document.getElementById('qtd-insumo-add');
            let qtd = parseMoney(qtdInput.value);
            if (qtd <= 0) return alert("Qtd inv√°lida!");

            let item, id, nome, custo;

            if (tipo === 'insumo') {
                id = document.getElementById('select-insumo-add').value;
                if (!id) return alert("Selecione um Insumo!");
                item = insumos.find(i => i.id == id);
                custo = parseMoney(item.custoUnitario);
                nome = item.nome;
            } else {
                id = document.getElementById('select-produto-add').value;
                if (!id) return alert("Selecione um Produto!");
                item = produtos.find(p => p.id == id);
                custo = item.custo || 0; 
                nome = item.nome + " (Pronto)";
            }

            if (!item) return alert("Item n√£o encontrado.");

            ingredientesTemp.push({
                tipo: tipo,
                id: item.id,
                nome: nome,
                custoUnit: custo,
                qtd: qtd,
                custoTotal: custo * qtd
            });

            renderIngredientesTemp();
            qtdInput.value = "1"; 
        }

        window.removerIngrediente = function(index) {
            ingredientesTemp.splice(index, 1);
            renderIngredientesTemp();
        };

        function renderIngredientesTemp() {
            let ul = document.getElementById('lista-ingredientes-temp');
            let precoVenda = parseMoney(document.getElementById('prod-preco').value);
            let custoTotal = ingredientesTemp.reduce((acc, i) => acc + i.custoTotal, 0);
            
            ul.innerHTML = ingredientesTemp.map((i, idx) => `
                <li class="list-group-item d-flex justify-content-between p-1">
                    <span>${i.qtd}x ${i.nome} <span class="badge bg-secondary">${i.tipo === 'produto' ? 'COMBO' : 'MP'}</span></span>
                    <span>
                        <small class="text-muted">R$ ${i.custoTotal.toFixed(2)}</small> 
                        <i class="fas fa-times text-danger ms-2" onclick="window.removerIngrediente(${idx})" style="cursor:pointer"></i>
                    </span>
                </li>
            `).join('');

            document.getElementById('prod-custo-total').innerText = `R$ ${custoTotal.toFixed(2)}`;
            let lucro = precoVenda - custoTotal;
            let elLucro = document.getElementById('prod-lucro-previsto');
            elLucro.innerText = `R$ ${lucro.toFixed(2)}`;
            elLucro.className = lucro < 0 ? "text-danger fw-bold" : "text-success fw-bold";
        }

        async function salvarProdutoFinal() {
            mostrarLoad(true);
            let idEdicao = document.getElementById('prod-id-edicao').value;
            let nome = document.getElementById('prod-nome').value;
            let preco = parseMoney(document.getElementById('prod-preco').value);
            let custo = ingredientesTemp.reduce((acc, i) => acc + i.custoTotal, 0);
            
            if(!nome) { mostrarLoad(false); return alert("Preencha o nome!"); }

            let dados = { nome, preco, custo, receita: ingredientesTemp };

            try {
                if (idEdicao) {
                    await updateDoc(doc(db, "produtos", idEdicao), dados);
                    alert("Atualizado! (Estoque inalterado)");
                } else {
                    await addDoc(collection(db, "produtos"), dados);
                    alert("Criado! (Estoque inalterado)");
                }
                cancelarEdicaoProduto();
                await init();
            } catch (e) { console.error(e); alert("Erro ao salvar: " + e.message); }
            mostrarLoad(false);
        }

        // --- PDV ---
        function addCarrinho() {
            let id = document.getElementById('pdv-produto').value;
            let qtd = parseInt(document.getElementById('pdv-qtd').value);
            let p = produtos.find(x => x.id == id);
            
            if(!p) return alert("Selecione um produto!");
            let custoProd = p.custo || 0;

            carrinho.push({ ...p, qtdVenda: qtd, custoUnitarioReal: custoProd });
            renderCarrinho();
        }

        function renderCarrinho() {
            let tbody = document.getElementById('pdv-carrinho');
            tbody.innerHTML = '';
            let total = 0;

            carrinho.forEach((item, index) => {
                let subtotal = item.preco * item.qtdVenda;
                let lucroLiquido = (item.preco - item.custoUnitarioReal) * item.qtdVenda;
                total += subtotal;

                tbody.innerHTML += `
                    <tr>
                        <td>${item.qtdVenda}x ${item.nome}</td>
                        <td>R$ ${subtotal.toFixed(2)}</td>
                        <td class="text-success fw-bold">R$ ${lucroLiquido.toFixed(2)}</td>
                        <td class="text-end">
                            <button onclick="window.removerItemCarrinho(${index})" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('pdv-total').innerText = `R$ ${total.toFixed(2)}`;
        }

        window.removerItemCarrinho = function(index) {
            carrinho.splice(index, 1);
            renderCarrinho();
        };

        async function baixarEstoqueRecursivo(receitaItem, multiplicador) {
            if(!receitaItem) return;
            for (const r of receitaItem) {
                if (r.tipo === 'produto') {
                    let subProduto = produtos.find(p => p.id == r.id);
                    if (subProduto && subProduto.receita) {
                        await baixarEstoqueRecursivo(subProduto.receita, r.qtd * multiplicador);
                    }
                } else {
                    let ins = insumos.find(x => x.id == r.id);
                    if(ins) {
                        let novoEstoque = ins.estoque - (r.qtd * multiplicador);
                        await updateDoc(doc(db, "insumos", ins.id), { estoque: novoEstoque });
                        ins.estoque = novoEstoque;
                    }
                }
            }
        }

        async function finalizarVenda() {
            if(carrinho.length === 0) return alert("Carrinho vazio!");
            mostrarLoad(true);
            
            let totalVenda = 0, totalCusto = 0;
            
            for (const item of carrinho) {
                totalVenda += item.preco * item.qtdVenda;
                totalCusto += item.custoUnitarioReal * item.qtdVenda;
                if(item.receita) {
                    await baixarEstoqueRecursivo(item.receita, item.qtdVenda);
                }
            }

            let numeroVenda = vendas.length + 1;
            let codigoVenda = "Venda " + numeroVenda;

            await addDoc(collection(db, "vendas"), { 
                data: new Date().toISOString(), 
                codigo: codigoVenda, 
                itens: carrinho.map(c => `${c.qtdVenda}x ${c.nome}`).join(', '), 
                total: totalVenda, 
                lucro: totalVenda - totalCusto 
            });

            carrinho = []; renderCarrinho(); 
            document.getElementById('pdv-total').innerText = 'R$ 0,00';
            
            atualizarTabelas(); 
            await init(); 
            
            mostrarLoad(false); 
            alert("Venda " + codigoVenda + " Realizada!");
        }

        // --- GERAIS (COM AJUSTE DE ESTOQUE MANUAL) ---
        async function salvarInsumo() {
            mostrarLoad(true);
            let idEdicao = document.getElementById('ins-id-edicao').value;
            let nome = document.getElementById('ins-nome').value;
            let qtd = parseMoney(document.getElementById('ins-qtd-pacote').value); // Qtd da Compra
            let valor = parseMoney(document.getElementById('ins-valor-pago').value);
            let un = document.getElementById('ins-unidade').value;
            let estoqueManual = parseMoney(document.getElementById('ins-estoque-atual').value); // Estoque Manual (Edi√ß√£o)

            if(!nome || !qtd || !valor) { mostrarLoad(false); return alert("Preencha todos os campos!"); }
            
            let custoUnitario = valor / qtd;

            try {
                if (idEdicao) {
                    await updateDoc(doc(db, "insumos", idEdicao), { 
                        nome, 
                        unidade: un, 
                        valorOriginal: valor, 
                        qtdOriginal: qtd, 
                        custoUnitario,
                        estoque: estoqueManual 
                    });
                    alert("Insumo atualizado! Estoque definido para: " + estoqueManual);

                } else {
                    await addDoc(collection(db, "insumos"), { 
                        data: new Date().toISOString(), 
                        nome, 
                        unidade: un, 
                        valorOriginal: valor, 
                        qtdOriginal: qtd, 
                        estoque: qtd, 
                        custoUnitario 
                    });
                    alert("Insumo cadastrado!");
                }
                
                await init();
                limparFormInsumo(); 
                cancelarEdicaoInsumo();
                
            } catch (e) { 
                console.error(e); 
                alert("Erro ao salvar: " + e.message); 
            }
            mostrarLoad(false);
        }

        function editarInsumo(id) {
            let item = insumos.find(i => i.id == id); 
            if(!item) return;

            document.getElementById('ins-id-edicao').value = item.id;
            document.getElementById('ins-nome').value = item.nome;
            document.getElementById('ins-qtd-pacote').value = item.qtdOriginal;
            document.getElementById('ins-valor-pago').value = item.valorOriginal.toString().replace('.', ',');
            document.getElementById('ins-unidade').value = item.unidade;
            
            document.getElementById('ins-estoque-atual').value = item.estoque;
            document.getElementById('div-estoque-atual').classList.remove('d-none');

            document.getElementById('titulo-form-insumo').innerText = "Editando: " + item.nome;
            document.getElementById('btn-salvar-insumo').innerHTML = "<i class='fas fa-save'></i>";
            document.getElementById('btn-salvar-insumo').classList.replace('btn-primary', 'btn-warning');
            document.getElementById('btn-cancelar-edicao').classList.remove('d-none');
            
            calcularCustoPreview();
            document.getElementById('insumos').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarEdicaoInsumo() {
            limparFormInsumo();
            
            document.getElementById('div-estoque-atual').classList.add('d-none');

            document.getElementById('titulo-form-insumo').innerText = "Nova Compra";
            document.getElementById('btn-salvar-insumo').innerHTML = "Cadastrar";
            document.getElementById('btn-salvar-insumo').classList.replace('btn-warning', 'btn-primary');
            document.getElementById('btn-cancelar-edicao').classList.add('d-none');
            document.getElementById('ins-id-edicao').value = "";
        }

        // --- ANOTA√á√ïES & COMPARADOR DE PRE√áOS (NOVO) ---
        window.compararPrecos = function() {
            let busca = document.getElementById('comp-busca').value.toLowerCase();
            if(!busca) return alert("Digite algo para buscar!");
            
            let resDiv = document.getElementById('resultado-comparacao');
            resDiv.innerHTML = '';

            let encontrados = listaAnotacoes.filter(a => a.item.toLowerCase().includes(busca));
            
            if(encontrados.length === 0) {
                resDiv.innerHTML = '<div class="alert alert-warning">Nenhum registro encontrado.</div>';
                return;
            }

            encontrados.sort((a, b) => a.preco - b.preco); // Ordena do menor para o maior

            let html = '<ul class="list-group mt-3">';
            encontrados.forEach((item, index) => {
                let destaque = index === 0 ? 'bg-success text-white' : 'bg-light';
                let tag = index === 0 ? '<span class="badge bg-warning text-dark">Melhor Pre√ßo üèÜ</span>' : '';
                
                html += `
                    <li class="list-group-item ${destaque} d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${item.item}</strong> <br>
                            <small>${item.fornecedor} | ${new Date(item.data).toLocaleDateString('pt-BR')}</small>
                        </div>
                        <div class="text-end">
                            <h5 class="m-0">R$ ${item.preco.toFixed(2)}</h5>
                            ${tag}
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            resDiv.innerHTML = html;
        }

        async function salvarAnotacao() {
            mostrarLoad(true);
            let idEdicao = document.getElementById('anot-id-edicao').value;
            let item = document.getElementById('anot-item').value;
            let fornecedor = document.getElementById('anot-fornecedor').value;
            let contato = document.getElementById('anot-contato').value;
            let preco = parseMoney(document.getElementById('anot-preco').value);
            let data = document.getElementById('anot-data').value;

            if(!item || !fornecedor || isNaN(preco) || !data) { mostrarLoad(false); return alert("Preencha dados!"); }

            // VERIFICA√á√ÉO DE PRE√áO (NOVO)
            // Procura itens com nome similar (cont√©m ou est√° contido)
            let termo = item.toLowerCase();
            let similares = listaAnotacoes.filter(a => {
                let nomeAntigo = a.item.toLowerCase();
                return (nomeAntigo.includes(termo) || termo.includes(nomeAntigo)) && a.id !== idEdicao;
            });

            if (similares.length > 0) {
                similares.sort((a,b) => a.preco - b.preco);
                let melhorOferta = similares[0];

                if (preco > melhorOferta.preco) {
                    let msg = `‚ö†Ô∏è ALERTA DE PRE√áO ALTO!\n\n`;
                    msg += `Voc√™ j√° comprou "${melhorOferta.item}" mais barato!\n`;
                    msg += `--------------------------------------\n`;
                    msg += `üí∞ Pre√ßo Atual: R$ ${preco.toFixed(2)}\n`;
                    msg += `üìâ Melhor Pre√ßo: R$ ${melhorOferta.preco.toFixed(2)}\n`;
                    msg += `üè≠ Fornecedor: ${melhorOferta.fornecedor}\n`;
                    msg += `üìÖ Data: ${new Date(melhorOferta.data).toLocaleDateString('pt-BR')}\n`;
                    msg += `--------------------------------------\n`;
                    msg += `Deseja salvar mesmo pagando mais caro?`;

                    if (!confirm(msg)) {
                        mostrarLoad(false);
                        return; // Cancela o salvamento
                    }
                }
            }

            let dados = { item, fornecedor, contato, preco, data };
            try {
                if (idEdicao) await updateDoc(doc(db, "anotacoes_precos", idEdicao), dados);
                else await addDoc(collection(db, "anotacoes_precos"), dados);
                cancelarEdicaoAnotacao();
                const sAnot = await getDocs(collection(db, "anotacoes_precos"));
                listaAnotacoes = sAnot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAnotacoes();
            } catch (e) { console.error(e); alert("Erro ao salvar."); }
            mostrarLoad(false);
        }

        function renderAnotacoes() {
            let tbody = document.getElementById('tabela-anotacoes');
            tbody.innerHTML = '';
            let filtroMes = document.getElementById('filtro-mes-anotacao').value;
            let listaFiltrada = listaAnotacoes.filter(a => {
                if(!filtroMes) return true;
                return a.data.startsWith(filtroMes);
            }).sort((a, b) => new Date(b.data) - new Date(a.data));

            listaFiltrada.forEach(a => {
                let dataFormatada = new Date(a.data).toLocaleDateString('pt-BR');
                tbody.innerHTML += `<tr><td>${dataFormatada}</td><td>${a.item}</td><td>${a.fornecedor}</td><td>${a.contato}</td><td class="fw-bold">R$ ${a.preco.toFixed(2)}</td><td class="text-end"><button onclick="window.editarAnotacao('${a.id}')" class="btn btn-sm btn-outline-warning"><i class="fas fa-pen"></i></button> <button onclick="window.excluirAnotacao('${a.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        function editarAnotacao(id) {
            let a = listaAnotacoes.find(x => x.id === id); if(!a) return;
            document.getElementById('anot-id-edicao').value = a.id;
            document.getElementById('anot-item').value = a.item;
            document.getElementById('anot-fornecedor').value = a.fornecedor;
            document.getElementById('anot-contato').value = a.contato;
            document.getElementById('anot-preco').value = a.preco.toString().replace('.', ',');
            document.getElementById('anot-data').value = a.data;
            document.getElementById('titulo-form-anot').innerText = "Editar Anota√ß√£o";
            document.getElementById('btn-salvar-anot').innerText = "Atualizar";
            document.getElementById('btn-cancelar-anot').classList.remove('d-none');
        }
        async function excluirAnotacao(id) {
            if(!confirm("Apagar?")) return; mostrarLoad(true);
            await deleteDoc(doc(db, "anotacoes_precos", id));
            listaAnotacoes = listaAnotacoes.filter(x => x.id !== id); renderAnotacoes(); mostrarLoad(false);
        }
        function cancelarEdicaoAnotacao() {
            document.getElementById('anot-id-edicao').value = ""; document.getElementById('anot-item').value = "";
            document.getElementById('anot-fornecedor').value = ""; document.getElementById('anot-contato').value = "";
            document.getElementById('anot-preco').value = ""; document.getElementById('anot-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('titulo-form-anot').innerText = "Nova Anota√ß√£o";
            document.getElementById('btn-salvar-anot').innerText = "Salvar Anota√ß√£o";
            document.getElementById('btn-cancelar-anot').classList.add('d-none');
        }
        function limparFiltroAnotacoes() { document.getElementById('filtro-mes-anotacao').value = ""; renderAnotacoes(); }

        function editarProduto(id) {
            let prod = produtos.find(p => p.id === id); if(!prod) return;
            document.getElementById('prod-id-edicao').value = prod.id;
            document.getElementById('prod-nome').value = prod.nome;
            document.getElementById('prod-preco').value = prod.preco.toString().replace('.', ',');
            
            ingredientesTemp = prod.receita ? JSON.parse(JSON.stringify(prod.receita)) : [];
            ingredientesTemp.forEach(i => { if(!i.tipo) i.tipo = 'insumo'; });

            renderIngredientesTemp();
            document.getElementById('titulo-form-prod').innerText = "Editando: " + prod.nome;
            document.getElementById('btn-salvar-prod').innerText = "Salvar Altera√ß√£o";
            document.getElementById('btn-salvar-prod').classList.replace('btn-success', 'btn-warning');
            document.getElementById('btn-cancelar-prod').classList.remove('d-none');
        }

        function cancelarEdicaoProduto() {
            document.getElementById('prod-id-edicao').value = "";
            document.getElementById('prod-nome').value = "";
            document.getElementById('prod-preco').value = "";
            ingredientesTemp = []; renderIngredientesTemp();
            document.getElementById('titulo-form-prod').innerText = "Novo Produto";
            document.getElementById('btn-salvar-prod').innerText = "Salvar Produto";
            document.getElementById('btn-salvar-prod').classList.replace('btn-warning', 'btn-success');
            document.getElementById('btn-cancelar-prod').classList.add('d-none');
        }

        function calcularCustoPreview() {
            let valor = parseMoney(document.getElementById('ins-valor-pago').value);
            let qtd = parseMoney(document.getElementById('ins-qtd-pacote').value);
            let custo = qtd > 0 ? valor / qtd : 0;
            document.getElementById('preview-custo').innerText = `Calculadora: R$ ${custo.toFixed(4)} / unidade`;
        }

        function limparFormInsumo() {
            document.getElementById('ins-nome').value = ''; document.getElementById('ins-valor-pago').value = '';
            document.getElementById('ins-qtd-pacote').value = ''; document.getElementById('preview-custo').innerText = '';
            document.getElementById('ins-estoque-atual').value = ''; 
        }
        async function excluirInsumo(id) {
            if(!confirm("Excluir?")) return; mostrarLoad(true);
            await deleteDoc(doc(db, "insumos", id)); await init(); mostrarLoad(false);
        }
        async function excluirProduto(id) {
            if(!confirm("Excluir?")) return; mostrarLoad(true);
            await deleteDoc(doc(db, "produtos", id)); await init(); mostrarLoad(false);
        }
        async function registrarMovimentacao(tipo) {
            mostrarLoad(true);
            let valor = parseMoney(document.getElementById(tipo === 'SAQUE' ? 'saque-valor' : 'aporte-valor').value);
            let desc = document.getElementById(tipo === 'SAQUE' ? 'saque-desc' : 'aporte-desc').value;
            if (!valor || !desc) { mostrarLoad(false); return alert("Preencha tudo!"); }
            await addDoc(collection(db, "mov_caixa"), { data: new Date().toISOString(), tipo, valor, descricao: desc });
            let el = document.querySelector(tipo === 'SAQUE' ? '#modalSaque' : '#modalAporte');
            bootstrap.Modal.getInstance(el).hide();
            document.getElementById(tipo === 'SAQUE' ? 'saque-valor' : 'aporte-valor').value = '';
            await init(); mostrarLoad(false); alert("Registrado!");
        }
        
        async function excluirTransacao(id, tipo) {
            if(!confirm("Apagar?")) return; mostrarLoad(true);
            let col = (tipo === 'VENDA') ? "vendas" : (tipo === 'COMPRA' ? "insumos" : "mov_caixa");
            await deleteDoc(doc(db, col, id)); await init(); mostrarLoad(false);
        }
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
            document.getElementById(id).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if(id === 'extrato') filtrarExtrato();
        }
        function mostrarLoad(ativo) { document.getElementById('loading-overlay').style.display = ativo ? 'flex' : 'none'; }
        
        function atualizarTabelas() {
            let selInsumo = document.getElementById('select-insumo-add'); 
            let selProd = document.getElementById('select-produto-add');
            
            selInsumo.innerHTML = '';
            insumos.forEach(i => selInsumo.innerHTML += `<option value="${i.id}">${i.nome}</option>`);

            selProd.innerHTML = '';
            produtos.forEach(p => selProd.innerHTML += `<option value="${p.id}">${p.nome}</option>`);

            document.getElementById('tabela-insumos').innerHTML = insumos.map(i => `<tr><td>${i.nome}</td><td>R$ ${(i.valorOriginal||0).toFixed(2)}</td><td>R$ ${i.custoUnitario.toFixed(3)}</td><td>${i.estoque.toFixed(1)} ${i.unidade}</td><td class="text-end"><button onclick="window.editarInsumo('${i.id}')" class="btn btn-sm btn-outline-warning"><i class="fas fa-pen"></i></button> <button onclick="window.excluirInsumo('${i.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            
            let sPdv = document.getElementById('pdv-produto'); sPdv.innerHTML = '';
            document.getElementById('tabela-produtos').innerHTML = produtos.map(p => { 
                sPdv.innerHTML += `<option value="${p.id}">${p.nome}</option>`; 
                let lucro = p.preco - p.custo;
                return `<tr><td>${p.nome}</td><td>R$ ${p.preco.toFixed(2)}</td><td class="text-success fw-bold">R$ ${lucro.toFixed(2)}</td><td class="text-end"><button onclick="window.editarProduto('${p.id}')" class="btn btn-sm btn-outline-warning"><i class="fas fa-pen"></i></button> <button onclick="window.excluirProduto('${p.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`; 
            }).join('');
        }
        function atualizarDashboard() {
            let totalFat = vendas.reduce((acc, v) => acc + v.total, 0);
            let totalGastos = insumos.reduce((acc, i) => acc + (i.valorOriginal || 0), 0);
            let totalLucro = vendas.reduce((acc, v) => acc + v.lucro, 0);
            let totalAportes = movCaixa.filter(m => m.tipo === 'APORTE').reduce((acc, m) => acc + m.valor, 0);
            let totalSaques = movCaixa.filter(m => m.tipo === 'SAQUE').reduce((acc, m) => acc + m.valor, 0);
            document.getElementById('dash-faturamento').innerText = `R$ ${totalFat.toFixed(2)}`;
            document.getElementById('dash-gastos').innerText = `R$ ${totalGastos.toFixed(2)}`;
            document.getElementById('dash-lucro').innerText = `R$ ${totalLucro.toFixed(2)}`;
            document.getElementById('dash-caixa').innerText = `R$ ${(totalFat + totalAportes - totalGastos - totalSaques).toFixed(2)}`;
        }
        let chartInstance = null;
        function limparFiltrosExtrato() {
            const hoje = new Date();
            document.getElementById('ext-data-ini').value = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('ext-data-fim').value = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0];
            document.getElementById('ext-filtro-tipo').value = 'TODOS';
            filtrarExtrato();
        }
        function filtrarExtrato() {
            let dataIni = new Date(document.getElementById('ext-data-ini').value);
            let dataFim = new Date(document.getElementById('ext-data-fim').value);
            let tipoFiltro = document.getElementById('ext-filtro-tipo').value; 

            dataFim.setHours(23, 59, 59);
            let transacoes = [];
            
            vendas.forEach(v => transacoes.push({ 
                id: v.id, 
                data: new Date(v.data), 
                tipo: 'VENDA', 
                codigo: v.codigo || '-', 
                descricao: v.itens, 
                valor: v.total, 
                classe: 'text-venda' 
            }));
            
            insumos.forEach(i => transacoes.push({ id: i.id, data: i.data ? new Date(i.data) : new Date(), tipo: 'COMPRA', codigo: '-', descricao: i.nome, valor: -(i.valorOriginal||0), classe: 'text-compra' }));
            movCaixa.forEach(m => transacoes.push({ id: m.id, data: new Date(m.data), tipo: m.tipo, codigo: '-', descricao: m.descricao, valor: m.tipo === 'SAQUE' ? -m.valor : m.valor, classe: m.tipo === 'SAQUE' ? 'text-saque' : 'text-aporte' }));
            
            let filtradas = transacoes.filter(t => {
                let dataOk = t.data >= dataIni && t.data <= dataFim;
                let tipoOk = true;
                if (tipoFiltro === 'MOV') {
                    tipoOk = (t.tipo === 'SAQUE' || t.tipo === 'APORTE');
                } else if (tipoFiltro !== 'TODOS') {
                    tipoOk = (t.tipo === tipoFiltro);
                }
                return dataOk && tipoOk;
            }).sort((a, b) => b.data - a.data);

            let tbody = document.getElementById('tabela-extrato'); tbody.innerHTML = '';
            let tEnt=0, tSai=0, tApo=0, tSaq=0;
            
            filtradas.forEach(t => {
                if(t.tipo === 'VENDA') tEnt += t.valor;
                if(t.tipo === 'COMPRA') tSai += Math.abs(t.valor);
                if(t.tipo === 'APORTE') tApo += t.valor;
                if(t.tipo === 'SAQUE') tSaq += Math.abs(t.valor);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${t.data.toLocaleDateString()}</td>
                        <td class="${t.classe}"><strong>${t.codigo !== '-' ? t.codigo : t.tipo}</strong></td>
                        <td>${t.descricao}</td>
                        <td class="${t.valor>=0?'text-success':'text-danger'}">R$ ${Math.abs(t.valor).toFixed(2)}</td>
                        <td class="text-end"><button onclick="window.excluirTransacao('${t.id}', '${t.tipo}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });

            document.getElementById('res-entradas').innerText = `R$ ${tEnt.toFixed(2)}`;
            document.getElementById('res-saidas').innerText = `R$ ${tSai.toFixed(2)}`;
            document.getElementById('res-saldo').innerText = `R$ ${(tEnt+tApo-tSai-tSaq).toFixed(2)}`;
            const ctx = document.getElementById('chartExtrato').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['Vendas', 'Compras', 'Aportes', 'Saques'], datasets: [{ label: 'R$', data: [tEnt, tSai, tApo, tSaq], backgroundColor: ['#2e7d32', '#c62828', '#0288d1', '#d32f2f'] }] } });
        }

        // --- EXPORTAR ---
        window.salvarInsumo = salvarInsumo;
        window.editarInsumo = editarInsumo;
        window.excluirInsumo = excluirInsumo;
        window.cancelarEdicaoInsumo = cancelarEdicaoInsumo;
        window.calcularCustoPreview = calcularCustoPreview;
        
        window.addItemAoProduto = addItemAoProduto; 
        window.salvarProdutoFinal = salvarProdutoFinal;
        window.editarProduto = editarProduto;
        window.excluirProduto = excluirProduto;
        window.cancelarEdicaoProduto = cancelarEdicaoProduto;
        
        window.addCarrinho = addCarrinho;
        window.finalizarVenda = finalizarVenda;
        window.registrarMovimentacao = registrarMovimentacao;
        window.excluirTransacao = excluirTransacao;
        window.showSection = showSection;
        window.filtrarExtrato = filtrarExtrato;
        window.limparFiltrosExtrato = limparFiltrosExtrato;

        window.salvarAnotacao = salvarAnotacao;
        window.editarAnotacao = editarAnotacao;
        window.excluirAnotacao = excluirAnotacao;
        window.cancelarEdicaoAnotacao = cancelarEdicaoAnotacao;
        window.renderAnotacoes = renderAnotacoes;
        window.limparFiltroAnotacoes = limparFiltroAnotacoes;
        
        window.compararPrecos = compararPrecos; // Exportando nova fun√ß√£o

        // Ativar Init
        init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
