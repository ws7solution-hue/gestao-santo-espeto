<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santo Espetinho - Gest√£o v22 (Fluxo Real)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary-color: #5C3A21; --secondary-color: #FFC107; --bg-light: #f8f9fa; }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', sans-serif; }
        
        .sidebar { height: 100vh; background-color: var(--primary-color); color: white; position: fixed; width: 250px; padding-top: 20px; overflow-y: auto; z-index: 1000; }
        .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 16px; color: white; display: block; transition: 0.3s; border-left: 5px solid transparent; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(255, 193, 7, 0.1); color: var(--secondary-color); border-left: 5px solid var(--secondary-color); font-weight: bold; }
        .content { margin-left: 250px; padding: 20px; }
        .card-custom { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
        
        .bg-gradient-brown { background: linear-gradient(45deg, #5C3A21, #8B5A2B); color: white; }
        .bg-gradient-red { background: linear-gradient(45deg, #d32f2f, #ef5350); color: white; }
        .bg-gradient-green { background: linear-gradient(45deg, #2e7d32, #4caf50); color: white; }
        
        .text-venda { color: #2e7d32; font-weight: bold; } 
        .text-compra { color: #c62828; font-weight: bold; } 
        .text-saque { color: #d32f2f; } 
        .text-aporte { color: #0277bd; font-weight: bold; }

        .alerta-estoque { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column; }
        
        @media (max-width: 768px) { .sidebar { width: 100%; height: auto; position: relative; } .content { margin-left: 0; } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3 text-dark">Carregando Sistema...</h5>
        <small class="text-muted" id="loading-msg">Conectando ao banco de dados...</small>
    </div>

    <div class="sidebar">
        <div class="text-center mb-4">
            <h3 class="mt-2"><i class="fas fa-fire"></i> Santo Espetinho</h3>
            <small>Gest√£o v22 (Fluxo Real)</small>
        </div>
        <a href="#" onclick="showSection('dashboard')" class="nav-link active"><i class="fas fa-chart-line"></i> Dashboard</a>
        <a href="#" onclick="showSection('extrato')" class="nav-link"><i class="fas fa-university"></i> Extrato Detalhado</a>
        <a href="#" onclick="showSection('anotacoes')" class="nav-link"><i class="fas fa-clipboard-list"></i> Anota√ß√µes (Gastos Reais)</a>
        <a href="#" onclick="showSection('insumos')" class="nav-link"><i class="fas fa-box-open"></i> 1. Estoque (Margem)</a>
        <a href="#" onclick="showSection('produtos')" class="nav-link"><i class="fas fa-utensils"></i> 2. Card√°pio / Combos</a>
        <a href="#" onclick="showSection('pdv')" class="nav-link"><i class="fas fa-cash-register"></i> Frente de Caixa</a>
    </div>

    <div class="content">
        <div id="alert-estoque-baixo" class="alert alert-danger d-none shadow-sm fw-bold">
            <i class="fas fa-exclamation-triangle"></i> Aten√ß√£o: Existem itens com estoque baixo!
        </div>

        <div id="dashboard" class="section">
            <h2>üìä Vis√£o Geral</h2>
            <hr>
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card card-custom p-3 bg-white">
                        <h5 class="mb-3">Caixa R√°pido</h5>
                        <div class="d-flex gap-3">
                            <button class="btn btn-outline-danger flex-grow-1" data-bs-toggle="modal" data-bs-target="#modalSaque"><i class="fas fa-hand-holding-usd"></i> Saque</button>
                            <button class="btn btn-outline-primary flex-grow-1" data-bs-toggle="modal" data-bs-target="#modalAporte"><i class="fas fa-piggy-bank"></i> Aporte</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-4 g-3">
                <div class="col-md-3"><div class="card card-custom bg-gradient-red p-3"><small>Total Gasto (Real)</small><h2 id="dash-gastos">R$ 0,00</h2></div></div>
                <div class="col-md-3"><div class="card card-custom bg-gradient-green p-3"><small>Total Vendido</small><h2 id="dash-faturamento">R$ 0,00</h2></div></div>
                <div class="col-md-3"><div class="card card-custom bg-gradient-brown p-3"><small>Lucro L√≠quido Real*</small><h2 id="dash-lucro">R$ 0,00</h2></div></div>
                <div class="col-md-3"><div class="card card-custom bg-secondary text-white p-3"><small>Saldo em Caixa</small><h2 id="dash-caixa">R$ 0,00</h2></div></div>
            </div>
            <small class="text-muted">*Lucro calculado com base no custo de reposi√ß√£o (Anota√ß√µes) + Vendas.</small>
        </div>

        <div id="extrato" class="section d-none">
            <h2>üìë Extrato Financeiro</h2>
            <p class="text-muted">Acompanhe vendas e gastos reais (Anota√ß√µes).</p>
            <hr>
            <div class="card card-custom p-3 mb-4">
                <div class="row g-2 align-items-end">
                    <div class="col-md-2">
                        <label>Filtrar por:</label>
                        <select id="ext-filtro-tipo" class="form-select">
                            <option value="TODOS">Todos</option>
                            <option value="VENDA">Vendas</option>
                            <option value="COMPRA">Compras (Reais)</option>
                            <option value="MOV">Caixa (Saque/Aporte)</option>
                        </select>
                    </div>
                    <div class="col-md-3"><label>In√≠cio</label><input type="date" id="ext-data-ini" class="form-control"></div>
                    <div class="col-md-3"><label>Fim</label><input type="date" id="ext-data-fim" class="form-control"></div>
                    <div class="col-md-2"><button onclick="filtrarExtrato()" class="btn btn-primary w-100">Filtrar</button></div>
                    <div class="col-md-2"><button onclick="limparFiltrosExtrato()" class="btn btn-outline-secondary w-100">Resetar</button></div>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-md-8"><div class="card card-custom p-3 h-100"><canvas id="chartExtrato" style="max-height: 250px;"></canvas></div></div>
                <div class="col-md-4">
                    <div class="card card-custom p-3 bg-light h-100">
                        <h5>Resumo</h5>
                        <ul class="list-group list-group-flush small">
                            <li class="list-group-item d-flex justify-content-between"><span class="text-success">Entradas</span><span id="res-entradas">R$ 0,00</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span class="text-danger">Sa√≠das (Real)</span><span id="res-saidas">R$ 0,00</span></li>
                            <li class="list-group-item d-flex justify-content-between"><span class="text-warning">Taxas Cart√£o</span><span id="res-taxas">R$ 0,00</span></li>
                            <li class="list-group-item d-flex justify-content-between"><strong>Saldo</strong><strong id="res-saldo">R$ 0,00</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card card-custom p-3"><div class="table-responsive"><table class="table table-striped table-sm"><thead class="table-dark"><tr><th>Data</th><th>Tipo/Pag.</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody id="tabela-extrato"></tbody></table></div></div>
        </div>

        <div id="insumos" class="section d-none">
            <h2>üì¶ Insumos & Estoque</h2>
            <p class="text-muted small">Aqui voc√™ cadastra o produto para controle de estoque e forma√ß√£o de pre√ßo (com margem de seguran√ßa).</p>
            <hr>
            <div class="card card-custom p-4 mb-4 border-start border-5 border-primary">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 id="titulo-form-insumo" class="m-0">Entrada de Estoque</h4>
                    <button id="btn-cancelar-edicao" class="btn btn-sm btn-secondary d-none" onclick="cancelarEdicaoInsumo()">Cancelar</button>
                </div>
                <input type="hidden" id="ins-id-edicao">
                <div class="row g-2 align-items-end">
                    <div class="col-md-3"><label>Item</label><input type="text" id="ins-nome" class="form-control" placeholder="Ex: Pct Embalagem"></div>
                    <div class="col-md-2"><label>Qtd Pacote</label><input type="number" id="ins-qtd-pacote" class="form-control" placeholder="Ex: 100"></div>
                    
                    <div class="col-md-2 d-none" id="div-estoque-atual">
                        <label class="text-danger fw-bold">Estoque Atual</label>
                        <input type="number" id="ins-estoque-atual" class="form-control border-danger fw-bold">
                    </div>

                    <div class="col-md-2"><label>Unidade</label><select id="ins-unidade" class="form-select"><option value="un">Un</option><option value="kg">kg</option><option value="g">g</option><option value="lt">lt</option></select></div>
                    <div class="col-md-2"><label>Valor (c/ Margem)</label><input type="text" id="ins-valor-pago" class="form-control" placeholder="Ex: 30,00"></div>
                    
                    <div class="col-md-1 bg-warning bg-opacity-10 p-1 rounded text-center">
                        <label class="small fw-bold text-dark" title="Adiciona uma % de seguran√ßa no custo">Margem(%)</label>
                        <input type="number" id="ins-margem" class="form-control form-control-sm text-center border-warning" placeholder="0" value="0">
                    </div>
                     <div class="col-md-1 bg-danger bg-opacity-10 p-1 rounded text-center">
                        <label class="small fw-bold text-dark" title="Avisa quando chegar nesse valor">M√≠nimo</label>
                        <input type="number" id="ins-estoque-min" class="form-control form-control-sm text-center border-danger" placeholder="5" value="5">
                    </div>

                    <div class="col-md-1"><button onclick="salvarInsumo()" id="btn-salvar-insumo" class="btn btn-primary w-100 fw-bold"><i class="fas fa-check"></i></button></div>
                </div>
                <div class="mt-2 d-flex justify-content-between">
                    <div class="text-primary fw-bold" id="preview-custo"><i class="fas fa-calculator"></i> Base: R$ 0,000</div>
                    <div class="text-danger fw-bold" id="preview-custo-op"><i class="fas fa-chart-line"></i> Final (c/ margem): R$ 0,000</div>
                </div>
            </div>
            <div class="card card-custom p-3">
                <table class="table table-hover align-middle">
                    <thead class="table-light"><tr><th>Item</th><th>Custo Base</th><th>Custo Margem</th><th>Estoque</th><th>Status</th><th class="text-end">A√ß√µes</th></tr></thead>
                    <tbody id="tabela-insumos"></tbody>
                </table>
            </div>
        </div>

        <div id="produtos" class="section d-none">
            <h2>üç¢ Card√°pio & Combos</h2>
            <hr>
            <div class="row">
                <div class="col-md-5">
                    <div class="card card-custom p-4 border-start border-5 border-warning">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 id="titulo-form-prod" class="m-0">Novo Produto/Combo</h4>
                            <button id="btn-cancelar-prod" class="btn btn-sm btn-secondary d-none" onclick="cancelarEdicaoProduto()">Cancelar</button>
                        </div>
                        
                        <input type="hidden" id="prod-id-edicao">

                        <div class="mb-2"><input type="text" id="prod-nome" class="form-control" placeholder="Nome (Ex: Combo Casal)"></div>
                        <div class="mb-2"><input type="text" id="prod-preco" class="form-control" placeholder="Pre√ßo de Venda (Ex: 45,90)"></div>
                        
                        <hr>
                        <div class="mb-2">
                            <label class="form-label small">O que adicionar na receita?</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="tipoItemAdd" id="radioInsumo" value="insumo" checked onchange="toggleTipoAdd()">
                                <label class="btn btn-outline-secondary" for="radioInsumo">Mat√©ria Prima</label>

                                <input type="radio" class="btn-check" name="tipoItemAdd" id="radioProduto" value="produto" onchange="toggleTipoAdd()">
                                <label class="btn btn-outline-warning" for="radioProduto">Produto Pronto</label>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-2">
                            <select id="select-insumo-add" class="form-select"></select>
                            <select id="select-produto-add" class="form-select d-none"></select>
                            
                            <input type="number" id="qtd-insumo-add" class="form-control" placeholder="Qtd" style="width: 80px;" value="1">
                            <button type="button" id="btn-add-ingrediente" class="btn btn-secondary"><i class="fas fa-plus"></i></button>
                        </div>
                        
                        <ul id="lista-ingredientes-temp" class="list-group mb-3 small"></ul>
                        
                        <div class="alert alert-secondary p-1 text-center">
                            Custo Op: <strong id="prod-custo-total">R$ 0,00</strong> | Lucro: <strong id="prod-lucro-previsto" class="text-success">R$ 0,00</strong>
                        </div>
                        
                        <button type="button" id="btn-salvar-prod" class="btn btn-success w-100">Salvar Produto/Combo</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card card-custom p-3">
                        <div class="input-group mb-3 shadow-sm">
                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="busca-produto-cardapio" class="form-control border-start-0" placeholder="Procurar produto no card√°pio..." onkeyup="filtrarTabelaProdutos()">
                        </div>
                        
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>Produto</th><th>Custo*</th><th>Venda</th><th>Lucro Real*</th><th class="text-end">A√ß√µes</th></tr></thead>
                            <tbody id="tabela-produtos"></tbody>
                        </table>
                        <small class="text-muted">*Valores considerando a margem de perda dos insumos.</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="pdv" class="section d-none">
            <h2>üõí Frente de Caixa</h2>
            <hr>
            <div class="row">
                <div class="col-md-5">
                    <div class="card card-custom p-4">
                        <h4>Lan√ßar Pedido</h4>
                        <div class="mb-3">
                            <label>Produto / Combo</label>
                            <select id="pdv-produto" class="form-select form-select-lg"></select>
                        </div>
                        <div class="mb-3">
                            <label>Quantidade</label>
                            <input type="number" id="pdv-qtd" class="form-control form-control-lg" value="1">
                        </div>
                        <button onclick="addCarrinho()" class="btn btn-warning w-100 btn-lg">Adicionar ao Carrinho</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card card-custom p-4 bg-white">
                        <h4>Carrinho de Compras</h4>
                        <div class="table-responsive">
                            <table class="table table-striped align-middle">
                                <thead class="table-light"><tr><th>Item</th><th>Venda</th><th>Lucro Liq.</th><th></th></tr></thead>
                                <tbody id="pdv-carrinho"></tbody>
                            </table>
                        </div>
                        <hr>
                        
                        <div class="row g-2 align-items-center mb-3 p-2 bg-light rounded">
                            <div class="col-md-6">
                                <label class="fw-bold">Forma Pagamento</label>
                                <select id="pdv-forma-pagamento" class="form-select" onchange="toggleTaxaInput()">
                                    <option value="DINHEIRO">Dinheiro</option>
                                    <option value="PIX">PIX</option>
                                    <option value="DEBITO">Cart√£o D√©bito</option>
                                    <option value="CREDITO">Cart√£o Cr√©dito</option>
                                </select>
                            </div>
                            <div class="col-md-6 d-none" id="div-taxa-maquina">
                                <label class="fw-bold text-danger">Taxa Maquininha (%)</label>
                                <input type="number" id="pdv-taxa-valor" class="form-control border-danger" value="0" placeholder="Ex: 4.5">
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="text-muted">Total:</h4>
                            <h2 id="pdv-total">R$ 0,00</h2>
                        </div>
                        <button onclick="finalizarVenda()" class="btn btn-success w-100 btn-lg mt-3">Receber Pedido (Gerar C√≥digo)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="anotacoes" class="section d-none">
            <h2>üìù Anota√ß√µes & Gastos Reais</h2>
            <p class="text-muted">Tudo que voc√™ lan√ßa aqui conta como "Gasto" no Dashboard.</p>
            <hr>
            
            <div class="card card-custom p-3 mb-4 bg-white border-start border-5 border-secondary">
                <h5>üîç Comparador de Pre√ßos (Unit√°rio)</h5>
                <div class="input-group">
                    <input type="text" id="comp-busca" class="form-control" placeholder="Digite o produto (Ex: Maionese)">
                    <button class="btn btn-secondary" onclick="compararPrecos()"><i class="fas fa-search"></i> Buscar Hist√≥rico</button>
                </div>
                <div id="resultado-comparacao" class="mt-3"></div>
            </div>
            
            <div class="card card-custom p-3 mb-4 bg-light">
                <div class="row align-items-center">
                    <div class="col-md-2"><strong>Filtrar M√™s:</strong></div>
                    <div class="col-md-4"><input type="month" id="filtro-mes-anotacao" class="form-control"></div>
                    <div class="col-md-2"><button onclick="renderAnotacoes()" class="btn btn-primary w-100">Buscar</button></div>
                    <div class="col-md-2"><button onclick="limparFiltroAnotacoes()" class="btn btn-outline-secondary w-100">Ver Tudo</button></div>
                </div>
            </div>

            <div class="card card-custom p-4 mb-4 border-start border-5 border-info">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 id="titulo-form-anot" class="m-0">Nova Anota√ß√£o / Gasto</h4>
                    <button id="btn-cancelar-anot" class="btn btn-sm btn-secondary d-none" onclick="cancelarEdicaoAnotacao()">Cancelar</button>
                </div>
                <input type="hidden" id="anot-id-edicao">
                
                <div class="row g-2">
                    <div class="col-md-4">
                        <label>Item</label>
                        <input type="text" id="anot-item" class="form-control" placeholder="Ex: Alcatra (kg)">
                    </div>
                    <div class="col-md-4">
                        <label>Estabelecimento/Fornecedor</label>
                        <input type="text" id="anot-fornecedor" class="form-control" placeholder="Ex: Mercado Central">
                    </div>
                    <div class="col-md-4">
                        <label>Contato (Opcional)</label>
                        <input type="text" id="anot-contato" class="form-control" placeholder="Tel/Zap">
                    </div>
                </div>
                
                <div class="row g-2 mt-2">
                    <div class="col-md-3">
                        <label>Tipo de Medida</label>
                        <select id="anot-medida" class="form-select" onchange="atualizarLabelQtd(); calcularTotalAnotacao();">
                            <option value="UN">Unidade (un)</option>
                            <option value="KG">Peso (g)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label id="lbl-qtd-anot">Qtd / Peso</label>
                        <input type="number" id="anot-qtd" class="form-control" placeholder="1" oninput="calcularTotalAnotacao()">
                    </div>
                    <div class="col-md-2">
                        <label id="lbl-valor-unit-anot">Vl. Unit / Kg</label>
                        <input type="text" id="anot-valor-unit" class="form-control" placeholder="0,00" oninput="calcularTotalAnotacao()">
                    </div>
                    <div class="col-md-2">
                        <label>Vl. Total</label>
                        <input type="text" id="anot-valor-total" class="form-control bg-light fw-bold" placeholder="R$ 0,00" readonly>
                    </div>
                    <div class="col-md-2">
                        <label>Data Pagamento</label>
                        <input type="date" id="anot-data" class="form-control">
                    </div>
                </div>

                <button onclick="salvarAnotacao()" id="btn-salvar-anot" class="btn btn-info text-white w-100 mt-3 fw-bold">Salvar Anota√ß√£o (Lan√ßa no Caixa)</button>
            </div>

            <div class="card card-custom p-3">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Data</th>
                                <th>Item</th>
                                <th>Local</th>
                                <th>Qtd/Peso</th>
                                <th>Vl. Unit/Kg</th>
                                <th>Vl. Total</th>
                                <th class="text-end">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-anotacoes"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modalSaque" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">Saque</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="saque-valor" class="form-control mb-2" placeholder="Valor (R$)"><input type="text" id="saque-desc" class="form-control" placeholder="Motivo"></div><div class="modal-footer"><button class="btn btn-danger" onclick="registrarMovimentacao('SAQUE')">Confirmar</button></div></div></div></div>
    <div class="modal fade" id="modalAporte" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Aporte</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="aporte-valor" class="form-control mb-2" placeholder="Valor (R$)"><input type="text" id="aporte-desc" class="form-control" placeholder="Origem"></div><div class="modal-footer"><button class="btn btn-primary" onclick="registrarMovimentacao('APORTE')">Confirmar</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDSSMRu3204Qx6D_HePLXOvWqZGYEuex3E",
            authDomain: "gestao-santo-espeto.firebaseapp.com",
            projectId: "gestao-santo-espeto",
            storageBucket: "gestao-santo-espeto.firebasestorage.app",
            messagingSenderId: "196041456523",
            appId: "1:196041456523:web:655bd6ac06ea34b06e4d8e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let insumos = [], produtos = [], vendas = [], movCaixa = [], listaAnotacoes = [];
        let ingredientesTemp = [], carrinho = [];

        function parseMoney(val) {
            if(!val) return 0;
            if(typeof val === 'number') return val;
            let str = val.toString().replace('.', '').replace(',', '.'); 
            if (val.toString().indexOf(',') > -1 && val.toString().indexOf('.') === -1) {
                return parseFloat(val.toString().replace(',', '.'));
            }
            return parseFloat(str) || 0;
        }

        function mostrarLoad(ativo) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = ativo ? 'flex' : 'none';
        }

        async function carregarDados() {
            try {
                const [sIns, sProd, sVen, sMov, sAnot] = await Promise.all([
                    getDocs(collection(db, "insumos")),
                    getDocs(collection(db, "produtos")),
                    getDocs(collection(db, "vendas")),
                    getDocs(collection(db, "mov_caixa")),
                    getDocs(collection(db, "anotacoes_precos"))
                ]);
                insumos = sIns.docs.map(d => ({ id: d.id, ...d.data() }));
                produtos = sProd.docs.map(d => ({ id: d.id, ...d.data() }));
                vendas = sVen.docs.map(d => ({ id: d.id, ...d.data() }));
                movCaixa = sMov.docs.map(d => ({ id: d.id, ...d.data() }));
                listaAnotacoes = sAnot.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) {
                console.error("Erro ao carregar dados:", e);
                alert("Erro ao carregar dados. Verifique sua internet.");
            }
        }

        function recalcularCustosProdutos() {
            if(!produtos || produtos.length === 0) return;
            produtos.forEach(p => {
                if(p.receita) {
                    let novoCusto = 0;
                    p.receita.forEach(item => {
                        let custoItemUnit = 0;
                        if(item.tipo === 'produto') {
                            let subP = produtos.find(x => x.id === item.id);
                            custoItemUnit = subP ? (subP.custo || 0) : 0;
                        } else {
                            let ins = insumos.find(x => x.id === item.id);
                            custoItemUnit = ins ? (ins.custoOperacional || ins.custoUnitario || 0) : 0;
                        }
                        novoCusto += custoItemUnit * item.qtd;
                    });
                    p.custo = novoCusto;
                }
            });
        }

        function atualizarTabelas() {
            let selInsumo = document.getElementById('select-insumo-add'); 
            let selProd = document.getElementById('select-produto-add');
            
            if(selInsumo) { selInsumo.innerHTML = ''; insumos.forEach(i => selInsumo.innerHTML += `<option value="${i.id}">${i.nome}</option>`); }
            if(selProd) { selProd.innerHTML = ''; produtos.forEach(p => selProd.innerHTML += `<option value="${p.id}">${p.nome}</option>`); }
            
            let alertaAtivo = false;
            let tbodyInsumos = document.getElementById('tabela-insumos');
            if(tbodyInsumos) {
                tbodyInsumos.innerHTML = insumos.map(i => {
                    let custoOp = i.custoOperacional ? i.custoOperacional : i.custoUnitario;
                    let minimo = i.estoqueMinimo || 0;
                    let critico = i.estoque <= minimo;
                    if(critico) alertaAtivo = true;
                    return `<tr class="${critico ? 'table-danger' : ''}"><td>${i.nome}</td><td>R$ ${i.custoUnitario.toFixed(3)}</td><td class="text-danger fw-bold">R$ ${custoOp.toFixed(3)} <small class="text-dark">(${i.margemPerda||0}%)</small></td><td>${i.estoque.toFixed(1)} ${i.unidade}</td><td>${critico ? '<span class="badge bg-danger alerta-estoque">Baixo!</span>' : '<span class="badge bg-success">Ok</span>'}</td><td class="text-end"><button onclick="window.editarInsumo('${i.id}')" class="btn btn-sm btn-outline-warning"><i class="fas fa-pen"></i></button> <button onclick="window.excluirInsumo('${i.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`;
                }).join('');
            }
            
            let divAlerta = document.getElementById('alert-estoque-baixo');
            if(divAlerta) { if(alertaAtivo) divAlerta.classList.remove('d-none'); else divAlerta.classList.add('d-none'); }

            let sPdv = document.getElementById('pdv-produto'); 
            if(sPdv) sPdv.innerHTML = '';
            
            let tbodyProdutos = document.getElementById('tabela-produtos');
            if(tbodyProdutos) {
                tbodyProdutos.innerHTML = produtos.map(p => { 
                    if(sPdv) sPdv.innerHTML += `<option value="${p.id}">${p.nome}</option>`; 
                    let custo = p.custo || 0;
                    let lucro = p.preco - custo; 
                    return `<tr>
                                <td>${p.nome}</td>
                                <td class="text-danger fw-bold">R$ ${custo.toFixed(2)}</td>
                                <td>R$ ${p.preco.toFixed(2)}</td>
                                <td class="${lucro < 0 ? 'text-danger' : 'text-success'} fw-bold">R$ ${lucro.toFixed(2)}</td>
                                <td class="text-end">
                                    <button onclick="window.editarProduto('${p.id}')" class="btn btn-sm btn-outline-warning"><i class="fas fa-pen"></i></button> 
                                    <button onclick="window.excluirProduto('${p.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>`; 
                }).join('');
            }
        }

        function filtrarTabelaProdutos() {
            let input = document.getElementById("busca-produto-cardapio");
            let filter = input.value.toUpperCase();
            let table = document.getElementById("tabela-produtos");
            let tr = table.getElementsByTagName("tr");

            for (let i = 0; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                    let textValue = td.textContent || td.innerText;
                    if (textValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        function atualizarDashboard() {
            let totalFat = vendas.reduce((acc, v) => acc + v.total, 0);
            let totalTaxas = vendas.reduce((acc, v) => acc + (v.taxaAplicada || 0), 0);
            
            let totalGastos = listaAnotacoes.reduce((acc, a) => acc + (a.valorTotal || 0), 0);
            let totalLucro = totalFat - totalTaxas - totalGastos; 
            
            let totalAportes = movCaixa.filter(m => m.tipo === 'APORTE').reduce((acc, m) => acc + m.valor, 0);
            let totalSaques = movCaixa.filter(m => m.tipo === 'SAQUE').reduce((acc, m) => acc + m.valor, 0);
            
            let caixaReal = totalFat - totalTaxas + totalAportes - totalGastos - totalSaques;

            document.getElementById('dash-faturamento').innerText = `R$ ${totalFat.toFixed(2)}`;
            document.getElementById('dash-gastos').innerText = `R$ ${totalGastos.toFixed(2)}`;
            document.getElementById('dash-lucro').innerText = `R$ ${totalLucro.toFixed(2)}`;
            document.getElementById('dash-caixa').innerText = `R$ ${caixaReal.toFixed(2)}`;
        }

        function calcularCustoPreview() {
            let valor = parseMoney(document.getElementById('ins-valor-pago').value);
            let qtd = parseMoney(document.getElementById('ins-qtd-pacote').value);
            let margem = parseMoney(document.getElementById('ins-margem').value);
            let custo = qtd > 0 ? valor / qtd : 0;
            let custoOp = custo * (1 + (margem / 100));
            document.getElementById('preview-custo').innerText = `Real: R$ ${custo.toFixed(4)}`;
            document.getElementById('preview-custo-op').innerText = `Operacional: R$ ${custoOp.toFixed(4)}`;
        }

        function limparFormInsumo() {
            document.getElementById('ins-nome').value = ''; document.getElementById('ins-valor-pago').value = '';
            document.getElementById('ins-qtd-pacote').value = ''; document.getElementById('ins-margem').value = '0';
            document.getElementById('ins-estoque-min').value = '5'; document.getElementById('preview-custo').innerText = 'Real: R$ 0,000';
            document.getElementById('preview-custo-op').innerText = 'Operacional: R$ 0,000'; document.getElementById('ins-estoque-atual').value = ''; 
        }

        async function salvarInsumo() {
            mostrarLoad(true);
            try {
                let idEdicao = document.getElementById('ins-id-edicao').value;
                let nome = document.getElementById('ins-nome').value;
                let qtd = parseMoney(document.getElementById('ins-qtd-pacote').value); 
                let valor = parseMoney(document.getElementById('ins-valor-pago').value);
                let un = document.getElementById('ins-unidade').value;
                let estoqueManual = parseMoney(document.getElementById('ins-estoque-atual').value); 
                let margem = parseMoney(document.getElementById('ins-margem').value);
                let estoqueMin = parseMoney(document.getElementById('ins-estoque-min').value); 

                if(!nome || !qtd || !valor) { mostrarLoad(false); return alert("Preencha todos os campos!"); }
                
                let custoUnitario = valor / qtd;
                let custoOperacional = custoUnitario * (1 + (margem / 100));

                let dados = { nome, unidade: un, valorOriginal: valor, qtdOriginal: qtd, custoUnitario, custoOperacional, margemPerda: margem, estoqueMinimo: estoqueMin };

                if (idEdicao) {
                    dados.estoque = estoqueManual;
                    await updateDoc(doc(db, "insumos", idEdicao), dados);
                    alert("Insumo atualizado!");
                } else {
                    dados.data = new Date().toISOString();
                    dados.estoque = qtd;
                    await addDoc(collection(db, "insumos"), dados);
                    alert("Insumo cadastrado!");
                }
                await init(); limparFormInsumo(); cancelarEdicaoInsumo();
            } catch (e) { console.error(e); alert("Erro ao salvar: " + e.message); }
            mostrarLoad(false);
        }

        function editarInsumo(id) {
            let item = insumos.find(i => i.id == id); if(!item) return;
            document.getElementById('ins-id-edicao').value = item.id;
            document.getElementById('ins-nome').value = item.nome;
            document.getElementById('ins-qtd-pacote').value = item.qtdOriginal;
            document.getElementById('ins-valor-pago').value = item.valorOriginal.toString().replace('.', ',');
            document.getElementById('ins-unidade').value = item.unidade;
            document.getElementById('ins-margem').value = item.margemPerda || 0;
            document.getElementById('ins-estoque-min').value = item.estoqueMinimo || 5; 
            document.getElementById('ins-estoque-atual').value = item.estoque;
            document.getElementById('div-estoque-atual').classList.remove('d-none');
            document.getElementById('titulo-form-insumo').innerText = "Editando: " + item.nome;
            const btn = document.getElementById('btn-salvar-insumo');
            btn.innerHTML = "<i class='fas fa-save'></i>"; btn.classList.replace('btn-primary', 'btn-warning');
            document.getElementById('btn-cancelar-edicao').classList.remove('d-none');
            calcularCustoPreview(); document.getElementById('insumos').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarEdicaoInsumo() {
            limparFormInsumo();
            document.getElementById('div-estoque-atual').classList.add('d-none');
            document.getElementById('titulo-form-insumo').innerText = "Nova Compra";
            const btn = document.getElementById('btn-salvar-insumo');
            btn.innerHTML = "Cadastrar"; btn.classList.replace('btn-warning', 'btn-primary');
            document.getElementById('btn-cancelar-edicao').classList.add('d-none');
            document.getElementById('ins-id-edicao').value = "";
        }

        async function excluirInsumo(id) { if(!confirm("Excluir?")) return; mostrarLoad(true); await deleteDoc(doc(db, "insumos", id)); await init(); mostrarLoad(false); }

        function toggleTipoAdd() {
            let tipo = document.querySelector('input[name="tipoItemAdd"]:checked').value;
            let selInsumo = document.getElementById('select-insumo-add');
            let selProd = document.getElementById('select-produto-add');
            if(tipo === 'insumo') { selInsumo.classList.remove('d-none'); selProd.classList.add('d-none'); } 
            else { selInsumo.classList.add('d-none'); selProd.classList.remove('d-none'); }
        }

        function addItemAoProduto() {
            let tipo = document.querySelector('input[name="tipoItemAdd"]:checked').value;
            let qtdInput = document.getElementById('qtd-insumo-add');
            let qtd = parseMoney(qtdInput.value);
            if (qtd <= 0) return alert("Qtd inv√°lida!");
            let item, id, nome, custo;

            if (tipo === 'insumo') {
                id = document.getElementById('select-insumo-add').value; if (!id) return alert("Selecione um Insumo!");
                item = insumos.find(i => i.id == id); custo = item.custoOperacional ? item.custoOperacional : parseMoney(item.custoUnitario); nome = item.nome;
            } else {
                id = document.getElementById('select-produto-add').value; if (!id) return alert("Selecione um Produto!");
                item = produtos.find(p => p.id == id); custo = item.custo || 0; nome = item.nome + " (Pronto)";
            }
            if (!item) return alert("Item n√£o encontrado.");
            ingredientesTemp.push({ tipo, id: item.id, nome, custoUnit: custo, qtd, custoTotal: custo * qtd });
            renderIngredientesTemp(); qtdInput.value = "1"; 
        }

        function removerIngrediente(index) { ingredientesTemp.splice(index, 1); renderIngredientesTemp(); }

        function renderIngredientesTemp() {
            let ul = document.getElementById('lista-ingredientes-temp');
            let precoVenda = parseMoney(document.getElementById('prod-preco').value);
            let custoTotal = ingredientesTemp.reduce((acc, i) => acc + i.custoTotal, 0);
            ul.innerHTML = ingredientesTemp.map((i, idx) => `<li class="list-group-item d-flex justify-content-between p-1"><span>${i.qtd}<span>${i.nome} <span class="badge bg-secondary">${i.tipo === 'produto' ? 'COMBO' : 'MP'}</span></span><span><small class="text-muted">R$ ${i.custoTotal.toFixed(2)}</small> <i class="fas fa-times text-danger ms-2" onclick="window.removerIngrediente(${idx})" style="cursor:pointer"></i></span></li>`).join('');
            document.getElementById('prod-custo-total').innerText = `R$ ${custoTotal.toFixed(2)}`;
            let lucro = precoVenda - custoTotal;
            let elLucro = document.getElementById('prod-lucro-previsto');
            elLucro.innerText = `R$ ${lucro.toFixed(2)}`;
            elLucro.className = lucro < 0 ? "text-danger fw-bold" : "text-success fw-bold";
        }

        async function salvarProdutoFinal() {
            mostrarLoad(true);
            try {
                let idEdicao = document.getElementById('prod-id-edicao').value;
                let nome = document.getElementById('prod-nome').value;
                let preco = parseMoney(document.getElementById('prod-preco').value);
                let custo = ingredientesTemp.reduce((acc, i) => acc + i.custoTotal, 0);
                if(!nome) { mostrarLoad(false); return alert("Preencha o nome!"); }
                let dados = { nome, preco, custo, receita: ingredientesTemp };
                if (idEdicao) { await updateDoc(doc(db, "produtos", idEdicao), dados); alert("Atualizado!"); } 
                else { await addDoc(collection(db, "produtos"), dados); alert("Criado!"); }
                cancelarEdicaoProduto(); await init();
            } catch (e) { console.error(e); alert("Erro ao salvar: " + e.message); }
            mostrarLoad(false);
        }

        function editarProduto(id) {
            let prod = produtos.find(p => p.id === id); if(!prod) return;
            document.getElementById('prod-id-edicao').value = prod.id;
            document.getElementById('prod-nome').value = prod.nome;
            document.getElementById('prod-preco').value = prod.preco.toString().replace('.', ',');
            ingredientesTemp = prod.receita ? JSON.parse(JSON.stringify(prod.receita)) : [];
            ingredientesTemp.forEach(i => { if(!i.tipo) i.tipo = 'insumo'; });
            renderIngredientesTemp();
            document.getElementById('titulo-form-prod').innerText = "Editando: " + prod.nome;
            const btn = document.getElementById('btn-salvar-prod');
            btn.innerText = "Salvar Altera√ß√£o"; btn.classList.replace('btn-success', 'btn-warning');
            document.getElementById('btn-cancelar-prod').classList.remove('d-none');
        }

        function cancelarEdicaoProduto() {
            document.getElementById('prod-id-edicao').value = ""; document.getElementById('prod-nome').value = "";
            document.getElementById('prod-preco').value = ""; ingredientesTemp = []; renderIngredientesTemp();
            document.getElementById('titulo-form-prod').innerText = "Novo Produto";
            const btn = document.getElementById('btn-salvar-prod'); btn.innerText = "Salvar Produto"; btn.classList.replace('btn-warning', 'btn-success');
            document.getElementById('btn-cancelar-prod').classList.add('d-none');
        }

        async function excluirProduto(id) { if(!confirm("Excluir?")) return; mostrarLoad(true); await deleteDoc(doc(db, "produtos", id)); await init(); mostrarLoad(false); }

        function addCarrinho() {
            let id = document.getElementById('pdv-produto').value;
            let qtd = parseInt(document.getElementById('pdv-qtd').value);
            let p = produtos.find(x => x.id == id);
            if(!p) return alert("Selecione um produto!");
            let custoProd = p.custo || 0; 
            carrinho.push({ ...p, qtdVenda: qtd, custoUnitarioReal: custoProd });
            renderCarrinho();
        }

        function renderCarrinho() {
            let tbody = document.getElementById('pdv-carrinho'); tbody.innerHTML = '';
            let total = 0;
            carrinho.forEach((item, index) => {
                let subtotal = item.preco * item.qtdVenda;
                let lucroLiquido = (item.preco - item.custoUnitarioReal) * item.qtdVenda;
                total += subtotal;
                tbody.innerHTML += `<tr><td>${item.qtdVenda}x ${item.nome}</td><td>R$ ${subtotal.toFixed(2)}</td><td class="${lucroLiquido < 0 ? 'text-danger' : 'text-success'} fw-bold">R$ ${lucroLiquido.toFixed(2)}</td><td class="text-end"><button onclick="window.removerItemCarrinho(${index})" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            document.getElementById('pdv-total').innerText = `R$ ${total.toFixed(2)}`;
        }

        function removerItemCarrinho(index) { carrinho.splice(index, 1); renderCarrinho(); }

        function toggleTaxaInput() {
            let forma = document.getElementById('pdv-forma-pagamento').value;
            let divTaxa = document.getElementById('div-taxa-maquina');
            if(forma === 'DEBITO' || forma === 'CREDITO') { divTaxa.classList.remove('d-none'); } else { divTaxa.classList.add('d-none'); }
        }

        async function baixarEstoqueRecursivo(receitaItem, multiplicador) {
            if(!receitaItem) return;
            for (const r of receitaItem) {
                if (r.tipo === 'produto') {
                    let subProduto = produtos.find(p => p.id == r.id);
                    if (subProduto && subProduto.receita) { await baixarEstoqueRecursivo(subProduto.receita, r.qtd * multiplicador); }
                } else {
                    let ins = insumos.find(x => x.id == r.id);
                    if(ins) {
                        let novoEstoque = ins.estoque - (r.qtd * multiplicador);
                        await updateDoc(doc(db, "insumos", ins.id), { estoque: novoEstoque });
                        ins.estoque = novoEstoque;
                    }
                }
            }
        }

        async function finalizarVenda() {
            if(carrinho.length === 0) return alert("Carrinho vazio!");
            mostrarLoad(true);
            try {
                let formaPagamento = document.getElementById('pdv-forma-pagamento').value;
                let taxaPercentual = 0;
                if (formaPagamento === 'CREDITO' || formaPagamento === 'DEBITO') {
                    taxaPercentual = parseMoney(document.getElementById('pdv-taxa-valor').value);
                    try { localStorage.setItem('santoEspetoTaxaPadrao', taxaPercentual); } catch(e) {}
                }
                let totalVenda = 0, totalCusto = 0;
                for (const item of carrinho) {
                    totalVenda += item.preco * item.qtdVenda;
                    totalCusto += item.custoUnitarioReal * item.qtdVenda;
                    if(item.receita) { await baixarEstoqueRecursivo(item.receita, item.qtdVenda); }
                }
                let valorTaxa = totalVenda * (taxaPercentual / 100);
                let lucroLiquido = totalVenda - totalCusto - valorTaxa;
                let numeroVenda = vendas.length + 1;
                let codigoVenda = "Venda " + numeroVenda;

                await addDoc(collection(db, "vendas"), { 
                    data: new Date().toISOString(), codigo: codigoVenda, itens: carrinho.map(c => `${c.qtdVenda}x ${c.nome}`).join(', '), 
                    total: totalVenda, lucro: lucroLiquido, formaPagamento: formaPagamento, taxaAplicada: valorTaxa, percTaxa: taxaPercentual
                });
                carrinho = []; renderCarrinho(); document.getElementById('pdv-total').innerText = 'R$ 0,00';
                atualizarTabelas(); await init(); alert(`Venda ${codigoVenda} Realizada!`);
            } catch (e) { console.error(e); alert("Erro ao finalizar venda: " + e.message); }
            mostrarLoad(false);
        }

        async function registrarMovimentacao(tipo) {
            mostrarLoad(true);
            let valor = parseMoney(document.getElementById(tipo === 'SAQUE' ? 'saque-valor' : 'aporte-valor').value);
            let desc = document.getElementById(tipo === 'SAQUE' ? 'saque-desc' : 'aporte-desc').value;
            if (!valor || !desc) { mostrarLoad(false); return alert("Preencha tudo!"); }
            await addDoc(collection(db, "mov_caixa"), { data: new Date().toISOString(), tipo, valor, descricao: desc });
            let idModal = tipo === 'SAQUE' ? '#modalSaque' : '#modalAporte';
            let el = document.querySelector(idModal);
            if(window.bootstrap) { let modalInstance = bootstrap.Modal.getInstance(el); if(modalInstance) modalInstance.hide(); }
            document.getElementById(tipo === 'SAQUE' ? 'saque-valor' : 'aporte-valor').value = '';
            await init(); mostrarLoad(false); alert("Registrado!");
        }

        async function excluirTransacao(id, tipo) {
            if(!confirm("Apagar?")) return; mostrarLoad(true);
            let col = (tipo === 'VENDA') ? "vendas" : (tipo === 'COMPRA' ? "insumos" : "mov_caixa");
            await deleteDoc(doc(db, col, id)); await init(); mostrarLoad(false);
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
            document.getElementById(id).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if(id === 'extrato') filtrarExtrato();
        }

        let chartInstance = null;
        function limparFiltrosExtrato() {
            const hoje = new Date();
            document.getElementById('ext-data-ini').value = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('ext-data-fim').value = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0];
            document.getElementById('ext-filtro-tipo').value = 'TODOS';
            filtrarExtrato();
        }

        function filtrarExtrato() {
            let dataIni = new Date(document.getElementById('ext-data-ini').value);
            let dataFim = new Date(document.getElementById('ext-data-fim').value);
            let tipoFiltro = document.getElementById('ext-filtro-tipo').value; 
            dataFim.setHours(23, 59, 59);
            let transacoes = [];
            
            vendas.forEach(v => transacoes.push({ id: v.id, data: new Date(v.data), tipo: 'VENDA', codigo: v.codigo || '-', descricao: `${v.itens} (${v.formaPagamento||'DINHEIRO'})`, valor: v.total, taxa: v.taxaAplicada||0, classe: 'text-venda' }));
            
            listaAnotacoes.forEach(a => {
                transacoes.push({ id: a.id, data: new Date(a.data), tipo: 'COMPRA', codigo: '-', descricao: `${a.item} (${a.fornecedor})`, valor: -(a.valorTotal||0), taxa: 0, classe: 'text-compra' });
            });

            movCaixa.forEach(m => transacoes.push({ id: m.id, data: new Date(m.data), tipo: m.tipo, codigo: '-', descricao: m.descricao, valor: m.tipo === 'SAQUE' ? -m.valor : m.valor, taxa: 0, classe: m.tipo === 'SAQUE' ? 'text-saque' : 'text-aporte' }));
            
            let filtradas = transacoes.filter(t => {
                let dataOk = t.data >= dataIni && t.data <= dataFim;
                let tipoOk = true;
                if (tipoFiltro === 'MOV') { tipoOk = (t.tipo === 'SAQUE' || t.tipo === 'APORTE'); } 
                else if (tipoFiltro !== 'TODOS') { tipoOk = (t.tipo === tipoFiltro); }
                return dataOk && tipoOk;
            }).sort((a, b) => b.data - a.data);

            let tbody = document.getElementById('tabela-extrato'); 
            tbody.innerHTML = '';
            let tEnt=0, tSai=0, tApo=0, tSaq=0, tTax=0;
            
            filtradas.forEach(t => {
                if(t.tipo === 'VENDA') { tEnt += t.valor; tTax += t.taxa; }
                if(t.tipo === 'COMPRA') tSai += Math.abs(t.valor);
                if(t.tipo === 'APORTE') tApo += t.valor;
                if(t.tipo === 'SAQUE') tSaq += Math.abs(t.valor);
                
                let textoValor = `R$ ${Math.abs(t.valor).toFixed(2)}`;
                if(t.taxa > 0) textoValor += ` <small class="text-danger">(-R$${t.taxa.toFixed(2)})</small>`;

                tbody.innerHTML += `<tr><td>${t.data.toLocaleDateString()}</td><td class="${t.classe}"><strong>${t.codigo !== '-' ? t.codigo : t.tipo}</strong></td><td>${t.descricao}</td><td class="${t.valor>=0?'text-success':'text-danger'}">${textoValor}</td><td class="text-end"><button onclick="window.excluirTransacao('${t.id}', '${t.tipo}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`;
            });

            document.getElementById('res-entradas').innerText = `R$ ${tEnt.toFixed(2)}`;
            document.getElementById('res-saidas').innerText = `R$ ${tSai.toFixed(2)}`;
            document.getElementById('res-taxas').innerText = `R$ ${tTax.toFixed(2)}`;
            document.getElementById('res-saldo').innerText = `R$ ${(tEnt+tApo-tSai-tSaq-tTax).toFixed(2)}`;
            
            const ctx = document.getElementById('chartExtrato').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['Vendas', 'Compras', 'Taxas', 'Saldo'], datasets: [{ label: 'R$', data: [tEnt, tSai, tTax, (tEnt+tApo-tSai-tSaq-tTax)], backgroundColor: ['#2e7d32', '#c62828', '#ff9800', '#0288d1'] }] } });
        }

        function atualizarLabelQtd() {
            let tipo = document.getElementById('anot-medida').value;
            let lblQtd = document.getElementById('lbl-qtd-anot');
            let lblUnit = document.getElementById('lbl-valor-unit-anot');
            if(tipo === 'KG') { lblQtd.innerText = "Peso (g)"; lblUnit.innerText = "Pre√ßo por KG"; } 
            else { lblQtd.innerText = "Quantidade"; lblUnit.innerText = "Pre√ßo Unit√°rio"; }
        }

        function calcularTotalAnotacao() {
            let qtd = parseMoney(document.getElementById('anot-qtd').value);
            let unit = parseMoney(document.getElementById('anot-valor-unit').value);
            let tipo = document.getElementById('anot-medida').value;
            let total = 0;
            if (tipo === 'KG') { total = (qtd / 1000) * unit; } else { total = qtd * unit; }
            document.getElementById('anot-valor-total').value = `R$ ${total.toFixed(2)}`;
        }

        async function salvarAnotacao() {
            mostrarLoad(true);
            let idEdicao = document.getElementById('anot-id-edicao').value;
            let item = document.getElementById('anot-item').value;
            let fornecedor = document.getElementById('anot-fornecedor').value;
            let contato = document.getElementById('anot-contato').value;
            let qtd = parseMoney(document.getElementById('anot-qtd').value);
            let unit = parseMoney(document.getElementById('anot-valor-unit').value);
            let tipo = document.getElementById('anot-medida').value;
            let data = document.getElementById('anot-data').value;

            if(!item || !fornecedor || !data) { mostrarLoad(false); return alert("Preencha Item, Fornecedor e Data!"); }
            let total = 0;
            if (tipo === 'KG') { total = (qtd / 1000) * unit; } else { total = qtd * unit; }

            let dados = { item, fornecedor, contato, qtd, valorUnitario: unit, valorTotal: total, tipoMedida: tipo, data };
            
            try {
                if (idEdicao) await updateDoc(doc(db, "anotacoes_precos", idEdicao), dados);
                else await addDoc(collection(db, "anotacoes_precos"), dados);
                cancelarEdicaoAnotacao();
                const sAnot = await getDocs(collection(db, "anotacoes_precos"));
                listaAnotacoes = sAnot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAnotacoes();
            } catch (e) { console.error(e); alert("Erro ao salvar."); }
            mostrarLoad(false);
        }

        function renderAnotacoes() {
            let tbody = document.getElementById('tabela-anotacoes'); tbody.innerHTML = '';
            let filtroMes = document.getElementById('filtro-mes-anotacao').value;
            let listaFiltrada = listaAnotacoes.filter(a => {
                if(!filtroMes) return true;
                return a.data.startsWith(filtroMes);
            }).sort((a, b) => new Date(b.data) - new Date(a.data));

            listaFiltrada.forEach(a => {
                let dataFormatada = new Date(a.data).toLocaleDateString('pt-BR');
                let qtd = a.qtd || 1;
                let vUnit = a.valorUnitario || a.preco || 0;
                let vTotal = a.valorTotal || (qtd * vUnit);
                let tipo = a.tipoMedida || 'UN';
                let displayQtd = tipo === 'KG' ? `${qtd} g` : `${qtd} un`;
                let displayUnit = tipo === 'KG' ? `R$ ${vUnit.toFixed(2)}/kg` : `R$ ${vUnit.toFixed(2)}`;

                tbody.innerHTML += `<tr><td>${dataFormatada}</td><td>${a.item}</td><td>${a.fornecedor}</td><td>${displayQtd}</td><td>${displayUnit}</td><td class="fw-bold">R$ ${vTotal.toFixed(2)}</td><td class="text-end"><button onclick="window.editarAnotacao('${a.id}')" class="btn btn-sm btn-outline-warning"><i class="fas fa-pen"></i></button> <button onclick="window.excluirAnotacao('${a.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        function editarAnotacao(id) {
            let a = listaAnotacoes.find(x => x.id === id); if(!a) return;
            document.getElementById('anot-id-edicao').value = a.id;
            document.getElementById('anot-item').value = a.item;
            document.getElementById('anot-fornecedor').value = a.fornecedor;
            document.getElementById('anot-contato').value = a.contato;
            
            let qtd = a.qtd || 1;
            let vUnit = a.valorUnitario || a.preco || 0;
            let tipo = a.tipoMedida || 'UN';

            document.getElementById('anot-medida').value = tipo;
            atualizarLabelQtd();

            document.getElementById('anot-qtd').value = qtd;
            document.getElementById('anot-valor-unit').value = vUnit.toString().replace('.', ',');
            calcularTotalAnotacao();

            document.getElementById('anot-data').value = a.data;
            document.getElementById('titulo-form-anot').innerText = "Editar Anota√ß√£o";
            document.getElementById('btn-salvar-anot').innerText = "Atualizar";
            document.getElementById('btn-cancelar-anot').classList.remove('d-none');
        }
        async function excluirAnotacao(id) { if(!confirm("Apagar?")) return; mostrarLoad(true); await deleteDoc(doc(db, "anotacoes_precos", id)); listaAnotacoes = listaAnotacoes.filter(x => x.id !== id); renderAnotacoes(); mostrarLoad(false); }
        function cancelarEdicaoAnotacao() {
            document.getElementById('anot-id-edicao').value = ""; document.getElementById('anot-item').value = "";
            document.getElementById('anot-fornecedor').value = ""; document.getElementById('anot-contato').value = "";
            document.getElementById('anot-qtd').value = ""; document.getElementById('anot-valor-unit').value = "";
            document.getElementById('anot-valor-total').value = ""; document.getElementById('anot-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('titulo-form-anot').innerText = "Nova Anota√ß√£o";
            document.getElementById('btn-salvar-anot').innerText = "Salvar Anota√ß√£o"; document.getElementById('btn-cancelar-anot').classList.add('d-none');
        }
        function limparFiltroAnotacoes() { document.getElementById('filtro-mes-anotacao').value = ""; renderAnotacoes(); }

        function compararPrecos() {
            let busca = document.getElementById('comp-busca').value.toLowerCase();
            if(!busca) return alert("Digite algo para buscar!");
            let resDiv = document.getElementById('resultado-comparacao'); resDiv.innerHTML = '';
            let encontrados = listaAnotacoes.filter(a => a.item.toLowerCase().includes(busca));
            if(encontrados.length === 0) { resDiv.innerHTML = '<div class="alert alert-warning">Nenhum registro encontrado.</div>'; return; }
            encontrados.sort((a, b) => (a.valorUnitario || a.preco) - (b.valorUnitario || b.preco));
            let html = '<ul class="list-group mt-3">';
            encontrados.forEach((item, index) => {
                let vUnit = item.valorUnitario || item.preco || 0;
                let tipo = item.tipoMedida || 'UN';
                let labelUnit = tipo === 'KG' ? '/kg' : '/un';
                let destaque = index === 0 ? 'bg-success text-white' : 'bg-light';
                let tag = index === 0 ? '<span class="badge bg-warning text-dark">Melhor Pre√ßo üèÜ</span>' : '';
                html += `<li class="list-group-item ${destaque} d-flex justify-content-between align-items-center"><div><strong>${item.item}</strong> <br><small>${item.fornecedor} | ${new Date(item.data).toLocaleDateString('pt-BR')}</small></div><div class="text-end"><h5 class="m-0">R$ ${vUnit.toFixed(2)} ${labelUnit}</h5>${tag}</div></li>`;
            });
            html += '</ul>'; resDiv.innerHTML = html;
        }

        async function init() {
            setTimeout(() => { const overlay = document.getElementById('loading-overlay'); if(overlay) overlay.style.display = 'none'; }, 10000);
            await carregarDados();
            recalcularCustosProdutos();
            atualizarTabelas();
            atualizarDashboard();
            limparFiltrosExtrato();
            renderAnotacoes();
            try { let taxaSalva = localStorage.getItem('santoEspetoTaxaPadrao'); if(taxaSalva) document.getElementById('pdv-taxa-valor').value = taxaSalva; } catch(e){}
            
            const btnAdd = document.getElementById('btn-add-ingrediente');
            if(btnAdd) { const newBtn = btnAdd.cloneNode(true); btnAdd.parentNode.replaceChild(newBtn, btnAdd); newBtn.addEventListener('click', addItemAoProduto); }
            const btnSalvarProd = document.getElementById('btn-salvar-prod');
            if(btnSalvarProd) { const newBtnS = btnSalvarProd.cloneNode(true); btnSalvarProd.parentNode.replaceChild(newBtnS, btnSalvarProd); newBtnS.addEventListener('click', salvarProdutoFinal); }
            const inputPreco = document.getElementById('prod-preco');
            if(inputPreco) inputPreco.addEventListener('input', renderIngredientesTemp);

            document.getElementById('ins-valor-pago').addEventListener('input', calcularCustoPreview);
            document.getElementById('ins-qtd-pacote').addEventListener('input', calcularCustoPreview);
            document.getElementById('ins-margem').addEventListener('input', calcularCustoPreview);
            document.getElementById('anot-data').value = new Date().toISOString().split('T')[0];
            mostrarLoad(false);
        }

        window.salvarInsumo = salvarInsumo; window.editarInsumo = editarInsumo; window.excluirInsumo = excluirInsumo;
        window.cancelarEdicaoInsumo = cancelarEdicaoInsumo; window.calcularCustoPreview = calcularCustoPreview;
        window.toggleTipoAdd = toggleTipoAdd; window.addItemAoProduto = addItemAoProduto; window.removerIngrediente = removerIngrediente;
        window.salvarProdutoFinal = salvarProdutoFinal; window.editarProduto = editarProduto; window.excluirProduto = excluirProduto; window.cancelarEdicaoProduto = cancelarEdicaoProduto;
        window.addCarrinho = addCarrinho; window.removerItemCarrinho = removerItemCarrinho; window.toggleTaxaInput = toggleTaxaInput; window.finalizarVenda = finalizarVenda;
        window.registrarMovimentacao = registrarMovimentacao; window.excluirTransacao = excluirTransacao;
        window.showSection = showSection; window.filtrarExtrato = filtrarExtrato; window.limparFiltrosExtrato = limparFiltrosExtrato;
        window.salvarAnotacao = salvarAnotacao; window.editarAnotacao = editarAnotacao; window.excluirAnotacao = excluirAnotacao;
        window.cancelarEdicaoAnotacao = cancelarEdicaoAnotacao; window.renderAnotacoes = renderAnotacoes; window.limparFiltroAnotacoes = limparFiltroAnotacoes;
        window.compararPrecos = compararPrecos; window.calcularTotalAnotacao = calcularTotalAnotacao; window.atualizarLabelQtd = atualizarLabelQtd;
        window.filtrarTabelaProdutos = filtrarTabelaProdutos;

        init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
